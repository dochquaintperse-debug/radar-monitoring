{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>ğŸ¯ ä¸“æ³¨çŠ¶æ€å®æ—¶ç›‘æµ‹</h3>
    </div>
    <div class="card-body" style="padding: 30px;">
        
        <!-- GitHub é“¾æ¥æç¤º -->
        <div class="alert alert-info">
            <h5>ğŸ“¦ è·å–æ¡¥æ¥å™¨ç¨‹åº</h5>
            <p>è¯·è®¿é—®æˆ‘ä»¬çš„GitHubä»“åº“ä¸‹è½½æ¡¥æ¥å™¨ï¼š</p>
            <a href="https://github.com/yourusername/radar-bridge" 
               class="btn btn-primary" target="_blank">
                ğŸ“¥ å‰å¾€ GitHub ä¸‹è½½
            </a>
            <p class="mt-2 mb-0">
                <small>è¿è¡Œæ¡¥æ¥å™¨åï¼Œè¾“å…¥æœ¬ç½‘ç«™åœ°å€è¿›è¡Œè¿æ¥</small>
            </p>
        </div>
        
        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="alert alert-info">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">ç­‰å¾…æ¡¥æ¥å™¨è¿æ¥...</span>
        </div>
        
        <!-- ç›‘æµ‹æŒ‰é’®å’ŒçŠ¶æ€ -->
        <div style="text-align: center; margin: 30px 0;">
            <button id="monitoringBtn" class="btn btn-primary btn-lg" disabled>
                ğŸ” å¼€å§‹ä¸“æ³¨ç›‘æµ‹
            </button>
            <div id="monitoringStatus" style="margin-top: 15px; display: none;">
                <div class="alert alert-warning">
                    <span id="statusMessage">æ­£åœ¨å¯åŠ¨ç›‘æµ‹...</span>
                </div>
            </div>
        </div>
        
        <!-- å®æ—¶å›¾è¡¨ -->
        <div class="card">
            <div class="card-header">
                <h4>ğŸ“Š å‘¼å¸æ•°æ®å®æ—¶å›¾è¡¨</h4>
            </div>
            <div class="card-body">
                <div style="height: 400px;">
                    <canvas id="breathChart"></canvas>
                </div>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let breathChart;
    let chartData = [];
    let chartLabels = [];
    let ws = null;
    let isConnected = false;
    let isBridgeConnected = false;
    let isMonitoring = false;
    let monitoringCountdown = 0;
    // WebSocketè¿æ¥
    function initWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + '//' + window.location.host + '/ws/radar/';
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('WebSocketè¿æ¥æˆåŠŸ');
            isConnected = true;
        };
        ws.onclose = function() {
            console.log('WebSocketè¿æ¥å…³é—­');
            isConnected = false;
            isBridgeConnected = false;
            updateStatus('disconnected', 'WebSocketè¿æ¥ä¸­æ–­');
            updateMonitoringButton();
            setTimeout(initWebSocket, 3000);
        };
        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            handleWebSocketMessage(data);
        };
    }
    // å¤„ç†WebSocketæ¶ˆæ¯
    function handleWebSocketMessage(data) {
        console.log('æ”¶åˆ°æ¶ˆæ¯:', data.type, data);
        
        switch(data.type) {
            case 'websocket_connected':
                updateStatus('connected', data.message);
                break;
                
            case 'radar_data':
                updateChart(data.timestamp, data.value);
                break;
                
            case 'bridge_connected':
                isBridgeConnected = true;
                updateStatus('connected', data.message);
                updateMonitoringButton();
                showNotification('success', 'æ¡¥æ¥å™¨è¿æ¥æˆåŠŸï¼å¯ä»¥å¼€å§‹ç›‘æµ‹');
                break;
                
            case 'bridge_disconnected':
                isBridgeConnected = false;
                updateStatus('warning', data.message);
                updateMonitoringButton();
                showNotification('error', 'æ¡¥æ¥å™¨è¿æ¥ä¸­æ–­ï¼');
                break;
                
            case 'monitoring_started':
                isMonitoring = true;
                updateMonitoringUI(true, data.message);
                break;
                
            case 'monitoring_countdown':
                updateCountdown(data.countdown, data.message);
                break;
                
            case 'monitoring_active':
                showNotification('info', data.message);
                updateMonitoringStatus(data.message);
                break;
                
            case 'data_collection':
                updateMonitoringStatus(data.message);
                break;
                
            case 'show_cloud':
                showFocusCloud(data);
                hideWarning(); // ä¸“æ³¨æ—¶éšè—è­¦å‘Š
                break;
                
            case 'show_warning':
                showFocusWarning(data);
                break;
                
            case 'monitoring_stopped':
                isMonitoring = false;
                updateMonitoringUI(false, data.message);
                hideWarning();
                hideCloud();
                break;
                
            case 'error_message':
                showNotification('error', data.message);
                break;
                
            case 'no_data_warning':
                showNotification('warning', data.message);
                break;
        }
    }
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(status, text) {
        const indicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        
        const statusClasses = {
            'connected': 'status-connected',
            'disconnected': 'status-disconnected', 
            'warning': 'status-warning'
        };
        
        indicator.className = `status-indicator ${statusClasses[status] || 'status-disconnected'}`;
        statusText.textContent = text;
    }
    // æ›´æ–°ç›‘æµ‹æŒ‰é’®çŠ¶æ€
    function updateMonitoringButton() {
        const btn = document.getElementById('monitoringBtn');
        
        if (!isConnected) {
            btn.disabled = true;
            btn.textContent = 'ğŸ” WebSocketæœªè¿æ¥';
        } else if (!isBridgeConnected) {
            btn.disabled = true;
            btn.textContent = 'ğŸ” ç­‰å¾…æ¡¥æ¥å™¨è¿æ¥';
        } else if (isMonitoring) {
            btn.disabled = false;
            btn.textContent = 'â¹ åœæ­¢ä¸“æ³¨ç›‘æµ‹';
        } else {
            btn.disabled = false;
            btn.textContent = 'ğŸ” å¼€å§‹ä¸“æ³¨ç›‘æµ‹';
        }
    }
    // æ›´æ–°ç›‘æµ‹UI
    function updateMonitoringUI(monitoring, message) {
        const status = document.getElementById('monitoringStatus');
        const statusMsg = document.getElementById('statusMessage');
        
        if (monitoring) {
            status.style.display = 'block';
            statusMsg.textContent = message;
            status.className = 'alert alert-info';
        } else {
            status.style.display = 'none';
        }
        
        updateMonitoringButton();
    }
    // æ›´æ–°å€’è®¡æ—¶
    function updateCountdown(countdown, message) {
        const statusMsg = document.getElementById('statusMessage');
        statusMsg.textContent = message;
        
        // æ›´æ–°æŒ‰é’®æ˜¾ç¤ºå€’è®¡æ—¶
        const btn = document.getElementById('monitoringBtn');
        btn.textContent = `â³ å‡†å¤‡ä¸­ ${countdown}s`;
    }
    // æ›´æ–°ç›‘æµ‹çŠ¶æ€æ¶ˆæ¯
    function updateMonitoringStatus(message) {
        const statusMsg = document.getElementById('statusMessage');
        if (statusMsg) {
            statusMsg.textContent = message;
        }
    }
    // æ˜¾ç¤ºä¸“æ³¨äº‘æœµ
    function showFocusCloud(data) {
        const cloud = document.getElementById('focusCloud');
        cloud.className = 'cloud show';
        
        showNotification('success', `ä¸“æ³¨çŠ¶æ€æ£€æµ‹æˆåŠŸï¼æ•°æ®ç‚¹: ${data.data_count}`);
        
        // 5ç§’åè‡ªåŠ¨éšè—
        setTimeout(() => {
            hideCloud();
        }, 5000);
    }
    // éšè—äº‘æœµ
    function hideCloud() {
        const cloud = document.getElementById('focusCloud');
        cloud.className = 'cloud hide';
    }
    // æ˜¾ç¤ºä¸“æ³¨è­¦å‘Š
    function showFocusWarning(data) {
        let warning = document.getElementById('focusWarning');
        
        if (!warning) {
            // åˆ›å»ºè­¦å‘Šå…ƒç´ 
            warning = document.createElement('div');
            warning.id = 'focusWarning';
            warning.className = 'focus-warning show';
            warning.innerHTML = `
                <div class="warning-content">
                    <div class="warning-icon">âš ï¸</div>
                    <div class="warning-text">
                        <strong>æ³¨æ„åŠ›åˆ†æ•£ï¼</strong><br>
                        <small>è¯·é‡æ–°ä¸“æ³¨</small>
                    </div>
                    <button class="warning-close" onclick="dismissWarning()">Ã—</button>
                </div>
            `;
            document.body.appendChild(warning);
        }
        
        warning.className = 'focus-warning show';
        showNotification('warning', `æ³¨æ„åŠ›åˆ†æ•£ï¼éä¸“æ³¨æ•°æ®: ${data.unfocus_values?.join(', ')}`);
    }
    // ç”¨æˆ·æ‰‹åŠ¨å…³é—­è­¦å‘Š
    function dismissWarning() {
        hideWarning();
        // é€šçŸ¥åç«¯ç”¨æˆ·å·²å…³é—­è­¦å‘Š
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({ command: 'dismiss_warning' }));
        }
    }
    // éšè—è­¦å‘Š
    function hideWarning() {
        const warning = document.getElementById('focusWarning');
        if (warning) {
            warning.className = 'focus-warning hide';
        }
    }
    // æ›´æ–°å›¾è¡¨
    function updateChart(timestamp, value) {
        const timeStr = new Date().toLocaleTimeString();
        
        chartLabels.push(timeStr);
        chartData.push(value);
        
        if (chartData.length > 100) {
            chartData.shift();
            chartLabels.shift();
        }
        
        breathChart.data.labels = chartLabels;
        breathChart.data.datasets[0].data = chartData;
        breathChart.update('none');
    }
    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(type, message) {
        const alertClasses = {
            'error': 'alert-danger',
            'warning': 'alert-warning', 
            'success': 'alert-success',
            'info': 'alert-info'
        };
        
        const icons = {
            'error': 'âŒ',
            'warning': 'âš ï¸',
            'success': 'âœ…',
            'info': 'â„¹ï¸'
        };
        
        const alertClass = alertClasses[type] || 'alert-info';
        const icon = icons[type] || 'â„¹ï¸';
        
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} notification`;
        notification.style.cssText = `
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 10000; 
            max-width: 350px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        `;
        notification.innerHTML = `${icon} ${message}`;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (document.body.contains(notification)) {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }
        }, 5000);
    }
    // åˆå§‹åŒ–å›¾è¡¨
    function initChart() {
        const ctx = document.getElementById('breathChart').getContext('2d');
        breathChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'å‘¼å¸æ•°å€¼',
                    data: chartData,
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 1,
                    pointHoverRadius: 4,
                    pointBackgroundColor: '#FFA500'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 0 },
                scales: {
                    y: { 
                        beginAtZero: true, 
                        max: 50,
                        grid: { color: '#DEB887' },
                        ticks: { color: '#8B4513' }
                    },
                    x: { 
                        grid: { color: '#DEB887' },
                        ticks: { 
                            color: '#8B4513',
                            maxTicksLimit: 10
                        }
                    }
                }
            }
        });
    }
    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initChart();
        initWebSocket();
        
        // ç›‘æµ‹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        document.getElementById('monitoringBtn').addEventListener('click', function() {
            if (!isConnected) {
                showNotification('error', 'WebSocketæœªè¿æ¥ï¼');
                return;
            }
            
            if (!isBridgeConnected) {
                showNotification('warning', 'è¯·å…ˆå¯åŠ¨æ¡¥æ¥å™¨è¿æ¥ï¼');
                return;
            }
            
            const command = isMonitoring ? 'stop_monitoring' : 'start_monitoring';
            ws.send(JSON.stringify({ command }));
        });
        
        // åˆå§‹çŠ¶æ€
        updateMonitoringButton();
    });
</script>
<!-- æ·»åŠ è­¦å‘Šæ ·å¼ -->
<style>
/* ä¸“æ³¨è­¦å‘Šç‰Œæ ·å¼ */
.focus-warning {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9998;
    background: linear-gradient(45deg, #dc3545, #c82333);
    color: white;
    border-radius: 15px;
    padding: 15px;
    box-shadow: 0 8px 32px rgba(220, 53, 69, 0.5);
    transform: translateX(400px);
    transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    max-width: 300px;
}
.focus-warning.show {
    transform: translateX(0);
    animation: warningShake 0.5s ease-in-out;
}
.focus-warning.hide {
    transform: translateX(400px);
}
@keyframes warningShake {
    0%, 100% { transform: translateX(0) rotate(0deg); }
    25% { transform: translateX(-5px) rotate(-1deg); }
    75% { transform: translateX(5px) rotate(1deg); }
}
.warning-content {
    display: flex;
    align-items: center;
    gap: 10px;
}
.warning-icon {
    font-size: 24px;
    animation: warningPulse 1s infinite;
}
@keyframes warningPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
.warning-text strong {
    display: block;
    font-size: 14px;
    margin-bottom: 2px;
}
.warning-text small {
    font-size: 12px;
    opacity: 0.9;
}
.warning-close {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
    padding: 0;
    margin-left: auto;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s;
}
.warning-close:hover {
    background: rgba(255, 255, 255, 0.2);
}
/* è­¦å‘ŠçŠ¶æ€æŒ‡ç¤ºå™¨ */
.status-warning {
    background: #ffc107;
    box-shadow: 0 0 15px #ffc107;
}
/* é€šçŸ¥åŠ¨ç”» */
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
</style>
{% endblock %}
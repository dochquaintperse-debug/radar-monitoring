{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>ğŸ¯ ä¸“æ³¨çŠ¶æ€å®æ—¶ç›‘æµ‹</h3>
    </div>
    <div class="card-body" style="padding: 30px;">
        
        <!-- GitHub é“¾æ¥æç¤º -->
        <div class="alert alert-info">
            <h5>ğŸ“¦ è·å–æ¡¥æ¥å™¨ç¨‹åº</h5>
            <p>è¯·è®¿é—®æˆ‘ä»¬çš„GitHubä»“åº“ä¸‹è½½æ¡¥æ¥å™¨ï¼š</p>
            <a href="https://github.com/yourusername/radar-bridge" 
               class="btn btn-primary" target="_blank">
                ğŸ“¥ å‰å¾€ GitHub ä¸‹è½½
            </a>
            <p class="mt-2 mb-0">
                <small>è¿è¡Œæ¡¥æ¥å™¨åï¼Œè¾“å…¥æœ¬ç½‘ç«™åœ°å€è¿›è¡Œè¿æ¥</small>
            </p>
        </div>
        
        <!-- è¿æ¥çŠ¶æ€ -->
        <div class="alert alert-info">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">ç­‰å¾…æ¡¥æ¥å™¨è¿æ¥...</span>
        </div>
        
        <!-- ç›‘æµ‹æŒ‰é’®å’ŒçŠ¶æ€ -->
        <div style="text-align: center; margin: 30px 0;">
            <button id="monitoringBtn" class="btn btn-primary btn-lg" disabled>
                ğŸ” å¼€å§‹ä¸“æ³¨ç›‘æµ‹
            </button>
            <div id="monitoringStatus" style="margin-top: 15px; display: none;">
                <div class="alert alert-warning">
                    <span id="statusMessage">æ­£åœ¨å¯åŠ¨ç›‘æµ‹...</span>
                </div>
            </div>
        </div>
        
        <!-- å®æ—¶å›¾è¡¨ -->
        <div class="card">
            <div class="card-header">
                <h4>ğŸ“Š å‘¼å¸æ•°æ®å®æ—¶å›¾è¡¨</h4>
            </div>
            <div class="card-body">
                <div style="height: 400px;">
                    <canvas id="breathChart"></canvas>
                </div>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let breathChart;
    let chartData = [];
    let chartLabels = [];
    let ws = null;
    let isConnected = false;
    let isMonitoring = false;
    let connectionTimeout = null;
    let reconnectAttempts = 0;
    let maxReconnectAttempts = 5;
    let pingInterval = null;

    // æ”¹è¿›çš„WebSocketè¿æ¥
    function initWebSocket() {
        if (ws && (ws.readyState === WebSocket.CONNECTING || ws.readyState === WebSocket.OPEN)) {
            return; // é¿å…é‡å¤è¿æ¥
        }

        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + '//' + window.location.host + '/ws/radar/';
        
        console.log('å°è¯•WebSocketè¿æ¥:', wsUrl);
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('WebSocketè¿æ¥æˆåŠŸ');
            updateStatus('connected', 'WebSocketå·²è¿æ¥ï¼Œç­‰å¾…æ•°æ®...');
            reconnectAttempts = 0;
            
            // å¯åŠ¨å¿ƒè·³
            startHeartbeat();
        };

        ws.onclose = function(event) {
            console.log('WebSocketè¿æ¥å…³é—­:', event.code, event.reason);
            updateStatus('disconnected', 'WebSocketå·²æ–­å¼€');
            isConnected = false;
            document.getElementById('monitoringBtn').disabled = true;
            
            stopHeartbeat();
            
            // è‡ªåŠ¨é‡è¿
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
                console.log(`${delay/1000}ç§’åé‡è¿ (å°è¯• ${reconnectAttempts}/${maxReconnectAttempts})`);
                setTimeout(initWebSocket, delay);
            } else {
                updateStatus('disconnected', 'WebSocketé‡è¿å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢');
            }
        };

        ws.onerror = function(error) {
            console.error('WebSocketé”™è¯¯:', error);
            updateStatus('disconnected', 'WebSocketè¿æ¥é”™è¯¯');
        };

        ws.onmessage = function(event) {
            try {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            } catch (e) {
                console.error('æ¶ˆæ¯è§£æå¤±è´¥:', e, event.data);
            }
        };
    }

    // å¿ƒè·³æœºåˆ¶
    function startHeartbeat() {
        stopHeartbeat(); // æ¸…é™¤æ—§çš„å¿ƒè·³
        pingInterval = setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ command: 'ping' }));
            }
        }, 30000); // æ¯30ç§’å‘é€å¿ƒè·³
    }

    function stopHeartbeat() {
        if (pingInterval) {
            clearInterval(pingInterval);
            pingInterval = null;
        }
    }

    // å¤„ç†WebSocketæ¶ˆæ¯
    function handleWebSocketMessage(data) {
        switch(data.type) {
            case 'radar_data':
                handleRadarData(data);
                break;
            case 'monitoring_started':
                isMonitoring = true;
                document.getElementById('monitoringBtn').textContent = 'â¹ åœæ­¢ç›‘æµ‹';
                document.getElementById('monitoringStatus').style.display = 'block';
                document.getElementById('statusMessage').textContent = data.message;
                break;
            case 'monitoring_stopped':
                isMonitoring = false;
                document.getElementById('monitoringBtn').textContent = 'ğŸ” å¼€å§‹ä¸“æ³¨ç›‘æµ‹';
                document.getElementById('monitoringStatus').style.display = 'none';
                break;
            case 'show_cloud':
                showFocusCloud(data);
                break;
            case 'focus_lost':
                console.log('ä¸“æ³¨çŠ¶æ€ç»“æŸ');
                break;
            case 'connection_warning':
                showNotification('warning', data.message);
                break;
            case 'pong':
                // å¿ƒè·³å“åº”ï¼Œä¿æŒè¿æ¥æ´»è·ƒ
                break;
            case 'error_message':
                console.error('æ”¶åˆ°é”™è¯¯:', data.message);
                showNotification('error', data.message);
                break;
            default:
                console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data);
        }
    }

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(type, message) {
        const alertClass = type === 'error' ? 'alert-danger' : 'alert-warning';
        const icon = type === 'error' ? 'âŒ' : 'âš ï¸';
        
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass}`;
        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        notification.innerHTML = `${icon} ${message}`;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 5000);
    }

    // å¤„ç†é›·è¾¾æ•°æ®
    function handleRadarData(data) {
        if (!isConnected) {
            isConnected = true;
            updateStatus('connected', 'æ¡¥æ¥å™¨å·²è¿æ¥ - æ•°æ®æ­£å¸¸');
            document.getElementById('monitoringBtn').disabled = false;
        }
        
        // é‡ç½®è¿æ¥è¶…æ—¶
        resetConnectionTimeout();
        updateChart(data.timestamp, data.value);
    }

    // è¿æ¥è¶…æ—¶ç®¡ç†
    function resetConnectionTimeout() {
        if (connectionTimeout) {
            clearTimeout(connectionTimeout);
        }
        
        connectionTimeout = setTimeout(() => {
            if (isConnected) {
                isConnected = false;
                updateStatus('disconnected', 'æ•°æ®è¿æ¥è¶…æ—¶ - è¯·æ£€æŸ¥æ¡¥æ¥å™¨');
                document.getElementById('monitoringBtn').disabled = true;
            }
        }, 45000); // 45ç§’è¶…æ—¶
    }

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(status, text) {
        const indicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        
        indicator.className = `status-indicator status-${status}`;
        statusText.textContent = text;
    }

    // æ›´æ–°å›¾è¡¨ - æ€§èƒ½ä¼˜åŒ–ç‰ˆ
    function updateChart(timestamp, value) {
        const now = new Date();
        const timeStr = now.toLocaleTimeString();
        
        chartLabels.push(timeStr);
        chartData.push(value);
        
        // ä¿æŒæœ€å¤š100ä¸ªæ•°æ®ç‚¹
        const maxPoints = 100;
        if (chartData.length > maxPoints) {
            chartData.shift();
            chartLabels.shift();
        }
        
        // æ‰¹é‡æ›´æ–°ï¼Œæé«˜æ€§èƒ½
        breathChart.data.labels = [...chartLabels];
        breathChart.data.datasets[0].data = [...chartData];
        
        // æ ¹æ®æ•°æ®é‡è°ƒæ•´æ›´æ–°æ¨¡å¼
        const updateMode = chartData.length > 50 ? 'none' : 'active';
        breathChart.update(updateMode);
    }

    // å¢å¼ºçš„ä¸“æ³¨äº‘æœµæ˜¾ç¤º
    function showFocusCloud(data) {
        const cloud = document.getElementById('focusCloud');
        cloud.className = 'cloud show';
        
        console.log(`ğŸ¯ æ£€æµ‹åˆ°ä¸“æ³¨çŠ¶æ€! æ•°æ®ç‚¹: ${data.data_count}, ä¸“æ³¨åº¦: ${data.focus_ratio}%`);
        
        // æ˜¾ç¤ºä¸“æ³¨åº¦ä¿¡æ¯
        if (data.focus_ratio) {
            showNotification('success', `ä¸“æ³¨çŠ¶æ€æ£€æµ‹æˆåŠŸï¼ä¸“æ³¨åº¦: ${data.focus_ratio}%`);
        }
        
        // 8ç§’åéšè—
        setTimeout(() => {
            cloud.className = 'cloud hide';
        }, 8000);
    }

    // åˆå§‹åŒ–å›¾è¡¨ - æ”¹è¿›ç‰ˆ
    function initChart() {
        const ctx = document.getElementById('breathChart').getContext('2d');
        breathChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'å‘¼å¸æ•°å€¼',
                    data: chartData,
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 1,
                    pointHoverRadius: 4,
                    pointBackgroundColor: '#FFA500'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                animation: {
                    duration: 300
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'å®æ—¶å‘¼å¸æ•°æ®ç›‘æµ‹',
                        color: '#8B4513',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        labels: { color: '#8B4513' }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(255, 215, 0, 0.9)',
                        titleColor: '#8B4513',
                        bodyColor: '#8B4513'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 50,
                        grid: { color: '#DEB887' },
                        ticks: { color: '#8B4513' }
                    },
                    x: {
                        grid: { color: '#DEB887' },
                        ticks: { 
                            color: '#8B4513',
                            maxTicksLimit: 10
                        }
                    }
                }
            }
        });
    }

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        initChart();
        initWebSocket();
        
                document.getElementById('monitoringBtn').addEventListener('click', function() {
            if (!isConnected) {
                showNotification('warning', 'è¯·å…ˆè¿æ¥æ¡¥æ¥å™¨ï¼');
                return;
            }
            
            if (!isMonitoring) {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ command: 'start_monitoring' }));
                } else {
                    showNotification('error', 'WebSocketè¿æ¥ä¸å¯ç”¨');
                }
            } else {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ command: 'stop_monitoring' }));
                } else {
                    showNotification('error', 'WebSocketè¿æ¥ä¸å¯ç”¨');
                }
            }
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œæ£€æŸ¥è¿æ¥çŠ¶æ€
                if (!ws || ws.readyState === WebSocket.CLOSED) {
                    console.log('é¡µé¢é‡æ–°å¯è§ï¼Œé‡æ–°è¿æ¥WebSocket');
                    setTimeout(initWebSocket, 1000);
                }
            }
        });

        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        window.addEventListener('beforeunload', function() {
            stopHeartbeat();
            if (ws) {
                ws.close(1000, 'Page unloading');
            }
        });
    });

    // æ·»åŠ æˆåŠŸé€šçŸ¥æ ·å¼
    function showNotification(type, message) {
        const alertClasses = {
            'error': 'alert-danger',
            'warning': 'alert-warning', 
            'success': 'alert-success',
            'info': 'alert-info'
        };
        
        const icons = {
            'error': 'âŒ',
            'warning': 'âš ï¸',
            'success': 'âœ…',
            'info': 'â„¹ï¸'
        };
        
        const alertClass = alertClasses[type] || 'alert-info';
        const icon = icons[type] || 'â„¹ï¸';
        
        const notification = document.createElement('div');
        notification.className = `alert ${alertClass}`;
        notification.style.cssText = `
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 9999; 
            max-width: 300px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease-out;
        `;
        notification.innerHTML = `${icon} ${message}`;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (document.body.contains(notification)) {
                notification.style.animation = 'slideOut 0.3s ease-in';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }
        }, 5000);
    }
</script>

<!-- æ·»åŠ CSSåŠ¨ç”» -->
<style>
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}

/* æ”¹è¿›æˆåŠŸæç¤ºæ ·å¼ */
.alert-success {
    background: linear-gradient(135deg, #d4edda, #c3e6cb);
    border-color: #28a745;
    color: #155724;
}

.alert-danger {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    border-color: #dc3545;
    color: #721c24;
}

.alert-warning {
    background: linear-gradient(135deg, #fff3cd, #ffeaa7);
    border-color: #ffc107;
    color: #856404;
}
</style>
{% endblock %}
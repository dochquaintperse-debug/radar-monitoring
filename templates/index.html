{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3>é›·è¾¾æ•°æ®ç›‘æ§</h3>
            </div>
            <div class="card-body">
                <!-- äº‘ç«¯ç¯å¢ƒæç¤º -->
                <div class="alert alert-info" role="alert">
                    <h5><i class="fas fa-info-circle"></i> äº‘ç«¯éƒ¨ç½²ç¯å¢ƒ</h5>
                    <p>å½“å‰è¿è¡Œåœ¨äº‘ç«¯ï¼Œæ— æ³•ç›´æ¥è®¿é—®æœ¬åœ°ä¸²å£è®¾å¤‡ã€‚</p>
                    <p><strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong></p>
                    <ol>
                        <li>ä¸‹è½½æ¡¥æ¥å™¨ç¨‹åºåˆ°æœ¬åœ°ç”µè„‘</li>
                        <li>å®‰è£…Pythonä¾èµ–</li>
                        <li>è¿è¡Œæ¡¥æ¥å™¨è¿æ¥é›·è¾¾è®¾å¤‡</li>
                        <li>åœ¨æ­¤ç•Œé¢æŸ¥çœ‹å®æ—¶æ•°æ®å’Œè®­ç»ƒç»“æœ</li>
                    </ol>
                    
                    <!-- ä¸‹è½½åŒºåŸŸ -->
                    <div class="mt-3">
                        <h6>ğŸ“¥ æ¡¥æ¥å™¨ä¸‹è½½ï¼š</h6>
                        <div class="btn-group" role="group">
                            <a href="/radar/download/setup/?windows=1" class="btn btn-success btn-sm">
                                ğŸªŸ Windowsä¸€é”®å®‰è£…
                            </a>
                            <a href="/radar/download/setup/" class="btn btn-success btn-sm">
                                ğŸ§ Linux/Macä¸€é”®å®‰è£…
                            </a>
                            <a href="/radar/download/bridge/" class="btn btn-outline-primary btn-sm">
                                ğŸ“„ ä»…ä¸‹è½½æ¡¥æ¥å™¨
                            </a>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                ğŸ’¡ æ¨èä½¿ç”¨ä¸€é”®å®‰è£…è„šæœ¬ï¼Œä¼šè‡ªåŠ¨å®‰è£…ä¾èµ–å¹¶ä¸‹è½½æ¡¥æ¥å™¨
                            </small>
                        </div>
                    </div>
                    
                    <div class="bg-dark text-success p-2 rounded mt-2">
                        <code>python radar_bridge.py</code>
                    </div>
                </div>
                
                <!-- è¿æ¥çŠ¶æ€æ˜¾ç¤º -->
                <div class="alert alert-secondary" role="alert">
                    <div class="d-flex align-items-center">
                        <div id="connectionStatusIndicator" class="mr-2" style="width: 12px; height: 12px; border-radius: 50%; background-color: #6c757d;"></div>
                        <span id="connectionStatusText">ç­‰å¾…æ¡¥æ¥å™¨è¿æ¥...</span>
                        <span id="lastDataTime" class="ml-auto text-muted"></span>
                    </div>
                </div>
                
                <!-- æ¨¡å¼æ§åˆ¶æŒ‰é’® -->
                <div class="mb-3">
                    <div class="d-flex gap-2">
                        <button id="trainingBtn" class="btn btn-primary btn-lg" disabled>è®­ç»ƒæ¨¡å¼</button>
                        <button id="monitoringBtn" class="btn btn-success btn-lg" disabled>ç›‘æµ‹æ¨¡å¼</button>
                        <small class="text-muted mt-2">* éœ€è¦æ¡¥æ¥å™¨è¿æ¥åæ‰èƒ½ä½¿ç”¨</small>
                    </div>
                </div>
                
                <!-- è®­ç»ƒçŠ¶æ€æ˜¾ç¤º -->
                <div id="trainingStatus" style="display: none; margin-bottom: 20px;">
                    <div class="alert alert-warning" role="alert">
                        <strong>è®­ç»ƒè¿›è¡Œä¸­...</strong>
                        <div class="progress mt-2">
                            <div id="trainingProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span id="trainingCountdown">å‰©ä½™æ—¶é—´: 60ç§’</span>
                            <span id="dataCollected">å·²æ”¶é›†: 0 ä¸ªæ•°æ®ç‚¹</span>
                        </div>
                    </div>
                </div>
                
                <!-- å®æ—¶å›¾è¡¨ -->
                <h4>å‘¼å¸æ•°æ®å®æ—¶å›¾è¡¨</h4>
                <div style="height: 300px; margin-bottom: 20px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                    <canvas id="breathChart"></canvas>
                </div>
                
                <!-- å®æ—¶æ•°æ®åˆ—è¡¨ -->
                <h4>å®æ—¶æ•°æ®</h4>
                <div class="data-container">
                    <ul id="realtime-data" class="list-group">
                        <li class="list-group-item text-muted">ç­‰å¾…æœ¬åœ°æ¡¥æ¥å™¨æ•°æ®...</li>
                    </ul>
                </div>
                
                <!-- ä¼ æ„Ÿå™¨çŠ¶æ€ -->
                <div class="mt-3">
                    <h4>ä¼ æ„Ÿå™¨çŠ¶æ€</h4>
                    <div id="sensorStatus">
                        {% if sensors %}
                            {% for sensor in sensors %}
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h5 class="card-title">{{ sensor.display_name }}</h5>
                                    {% if sensor.latest_training %}
                                        <p class="card-text">å¹³å‡å€¼: {{ sensor.latest_training.average_value|floatformat:2 }}</p>
                                        <p class="card-text text-muted">{{ sensor.latest_training.created_at }}</p>
                                        <p class="card-text">
                                            æœ€æ–°æ•°å€¼: 
                                            <span id="latest-value-{{ sensor.id }}" class="badge badge-info">--</span>
                                        </p>
                                    {% else %}
                                        <p class="card-text text-warning">æœªè®­ç»ƒ</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">æš‚æ— ä¼ æ„Ÿå™¨æ•°æ®ï¼Œè¯·ç¡®è®¤æœ¬åœ°æ¡¥æ¥å™¨æ­£åœ¨è¿è¡Œ</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3>è®­ç»ƒç»“æœ</h3>
            </div>
            <div class="card-body">
                <div id="trainingResults">
                    {% if sensors %}
                        {% for sensor in sensors %}
                            {% if sensor.latest_training %}
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ sensor.display_name }}</h5>
                                        <p class="card-text">å¹³å‡å€¼: {{ sensor.latest_training.average_value|floatformat:2 }}</p>
                                        <p class="card-text text-muted">{{ sensor.latest_training.created_at }}</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">æš‚æ— è®­ç»ƒç»“æœ</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let breathChart;
    let chartData = [];
    let chartLabels = [];
    let trainingTimer = null;
    let trainingCountdownTimer = null;
    let ws = null;
    let isConnected = false;
    let lastDataTime = null;
    let dataCollectedCount = 0;
    let isTraining = false;
    
    // WebSocketè¿æ¥åˆå§‹åŒ–
    function initWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + '//' + window.location.host + '/ws/radar/';
        
        console.log('è¿æ¥WebSocket: ' + wsUrl);
        
        try {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocketè¿æ¥æˆåŠŸ');
                document.getElementById('statusIndicator').className = 'connected';
                document.getElementById('connectionStatus').textContent = 'è¿æ¥çŠ¶æ€ï¼šWebSocketå·²è¿æ¥';
                toastr.success('ç³»ç»Ÿè¿æ¥æˆåŠŸ');
            };

            ws.onclose = function(event) {
                console.log('WebSocketè¿æ¥å…³é—­');
                document.getElementById('statusIndicator').className = 'disconnected';
                document.getElementById('connectionStatus').textContent = 'è¿æ¥çŠ¶æ€ï¼šWebSocketå·²æ–­å¼€';
                if (!event.wasClean) {
                    toastr.warning('è¿æ¥æ–­å¼€ï¼Œ3ç§’åé‡è¯•...');
                    setTimeout(initWebSocket, 3000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                toastr.error('ç³»ç»Ÿè¿æ¥å¤±è´¥');
            };
            
            // æ¶ˆæ¯å¤„ç†
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('æ”¶åˆ°WebSocketæ¶ˆæ¯:', data); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                
                switch(data.type) {
                    case 'training_started':
                        console.log('è®­ç»ƒå¯åŠ¨æˆåŠŸ:', data.message); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                        toastr.success(data.message); // æ”¹ä¸ºsuccessæ˜¾ç¤º
                        isTraining = true;
                        dataCollectedCount = 0;
                        $('#trainingStatus').show();
                        $('#trainingBtn').text('åœæ­¢è®­ç»ƒ').data('training', true);
                        $('#monitoringBtn').prop('disabled', true);
                        startTrainingCountdown();
                        break;

                    case 'radar_data':
                        updateConnectionStatus(true);
                        updateRealtimeData(data);
                        updateSensorStatus(data);
                        updateBreathChart(data.timestamp, data.value);
                        
                        // è®­ç»ƒæœŸé—´è®¡æ•°
                        if (isTraining) {
                            dataCollectedCount++;
                            $('#dataCollected').text(`å·²æ”¶é›†: ${dataCollectedCount} ä¸ªæ•°æ®ç‚¹`);
                        }
                        break;
                        
                    case 'training_complete':
                        handleTrainingComplete(data);
                        break;

                    case 'training_stopped':
                        handleTrainingStopped();
                        break;

                    case 'monitoring_started':
                        $('#monitoringBtn').text('åœæ­¢ç›‘æµ‹').removeClass('btn-success').addClass('btn-danger');
                        $('#monitoringBtn').data('monitoring', true);
                        toastr.info('ç›‘æµ‹å·²å¼€å§‹');
                        break;

                    case 'monitoring_stopped':
                        $('#monitoringBtn').text('ç›‘æµ‹æ¨¡å¼').removeClass('btn-danger').addClass('btn-success');
                        $('#monitoringBtn').data('monitoring', false);
                        toastr.info('å·²åœæ­¢ç›‘æµ‹');
                        break;

                    case 'anomaly_detected':
                        handleAnomalyDetection(data);
                        break;
                        
                    case 'error_message':
                        console.error('æ”¶åˆ°é”™è¯¯æ¶ˆæ¯:', data.message); // æ·»åŠ è°ƒè¯•æ—¥å¿—
                        toastr.error(data.message);
                        
                        // å¦‚æœæ˜¯è®­ç»ƒå¯åŠ¨å¤±è´¥ï¼Œé‡ç½®æŒ‰é’®çŠ¶æ€
                        if (data.message.includes('å¯åŠ¨è®­ç»ƒå¤±è´¥')) {
                            $('#trainingBtn').text('è®­ç»ƒæ¨¡å¼').data('training', false);
                            $('#trainingStatus').hide();
                            $('#monitoringBtn').prop('disabled', false);
                        }
                        break;
                }
            };
            
        } catch (error) {
            console.error('WebSocketåˆå§‹åŒ–å¤±è´¥:', error);
            toastr.error('ç³»ç»Ÿè¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
    }
    
    // æ›´æ–°è¿æ¥çŠ¶æ€
    function updateConnectionStatus(hasData) {
        if (hasData) {
            isConnected = true;
            lastDataTime = new Date();
            
            // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
            document.getElementById('connectionStatusIndicator').style.backgroundColor = '#28a745'; // ç»¿è‰²
            document.getElementById('connectionStatusText').textContent = 'æ¡¥æ¥å™¨å·²è¿æ¥ - æ•°æ®æ­£å¸¸';
            document.getElementById('lastDataTime').textContent = `æœ€åæ•°æ®: ${lastDataTime.toLocaleTimeString()}`;
            
            // å¯ç”¨æŒ‰é’®
            $('#trainingBtn').prop('disabled', false);
            $('#monitoringBtn').prop('disabled', false);
        }
        
        // æ£€æŸ¥è¿æ¥è¶…æ—¶ï¼ˆ30ç§’æ— æ•°æ®è®¤ä¸ºæ–­å¼€ï¼‰
        setTimeout(function() {
            if (lastDataTime && (new Date() - lastDataTime) > 30000) {
                isConnected = false;
                document.getElementById('connectionStatusIndicator').style.backgroundColor = '#dc3545'; // çº¢è‰²
                document.getElementById('connectionStatusText').textContent = 'æ¡¥æ¥å™¨è¿æ¥è¶…æ—¶';
                $('#trainingBtn').prop('disabled', true);
                $('#monitoringBtn').prop('disabled', true);
            }
        }, 30000);
    }
    
    // æ›´æ–°å®æ—¶æ•°æ®åˆ—è¡¨
    function updateRealtimeData(data) {
        const dataList = document.getElementById('realtime-data');
        
        if (dataList.children.length === 1 && dataList.children[0].textContent.includes('ç­‰å¾…')) {
            dataList.innerHTML = '';
        }
        
        const newItem = document.createElement('li');
        newItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        
        const timeStr = new Date(data.timestamp).toLocaleTimeString();
        newItem.innerHTML = '<div>' +
            '<strong>ä¼ æ„Ÿå™¨ ' + data.sensor_id + '</strong>: ' + data.value + ' ' +
            '<small class="text-muted">(' + data.hex_value + ')</small>' +
            '</div>' +
            '<small class="text-muted">' + timeStr + '</small>';
        
        dataList.insertBefore(newItem, dataList.firstChild);

        // é™åˆ¶æ˜¾ç¤ºæ¡æ•°
        while (dataList.children.length > 20) {
            dataList.removeChild(dataList.lastChild);
        }
    }
    
    // æ›´æ–°ä¼ æ„Ÿå™¨çŠ¶æ€
    function updateSensorStatus(data) {
        const sensorIdNum = data.sensor_id.replace(/\D/g, '');
        const latestValueElem = document.getElementById('latest-value-' + sensorIdNum);
        if (latestValueElem) {
            latestValueElem.textContent = data.value;
            latestValueElem.className = 'badge badge-success';
            
            setTimeout(function() {
                latestValueElem.className = 'badge badge-info';
            }, 3000);
        }
    }
    
    // å¤„ç†è®­ç»ƒå®Œæˆ
    function handleTrainingComplete(data) {
        toastr.success('ä¼ æ„Ÿå™¨ ' + data.sensor_id + ' è®­ç»ƒå®Œæˆï¼Œå¹³å‡å€¼: ' + data.average_value.toFixed(2));
        
        if (trainingTimer) {
            clearTimeout(trainingTimer);
            trainingTimer = null;
        }
        stopTrainingCountdown();
        
        isTraining = false;
        $('#trainingBtn').prop('disabled', false).text('è®­ç»ƒæ¨¡å¼').data('training', false);
        $('#monitoringBtn').prop('disabled', false);
        $('#trainingStatus').hide();
        
        setTimeout(function() {
            location.reload();
        }, 2000);
    }
    
    // å¤„ç†è®­ç»ƒåœæ­¢
    function handleTrainingStopped() {
        if (trainingTimer) {
            clearTimeout(trainingTimer);
            trainingTimer = null;
        }
        stopTrainingCountdown();
        
        isTraining = false;
        $('#trainingBtn').text('è®­ç»ƒæ¨¡å¼').data('training', false);
        $('#monitoringBtn').prop('disabled', false);
        $('#trainingStatus').hide();
        toastr.info('è®­ç»ƒå·²åœæ­¢');
    }
    
    // å¤„ç†å¼‚å¸¸æ£€æµ‹
    function handleAnomalyDetection(data) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = '<strong>å¼‚å¸¸è­¦å‘Š!</strong><br>' +
            'ä¼ æ„Ÿå™¨ ' + data.sensor_id + ' æ£€æµ‹åˆ°å¼‚å¸¸<br>' +
            'å¼‚å¸¸å€¼: ' + data.values.join(', ') + '<br>' +
            'åŸºå‡†å€¼: ' + data.average.toFixed(2);
        document.body.appendChild(alertDiv);
        
        setTimeout(function() {
            alertDiv.remove();
        }, 5000);
        
        toastr.error('æ£€æµ‹åˆ°å‘¼å¸å¼‚å¸¸ï¼');
    }

    // å‘é€WebSocketå‘½ä»¤
    function sendWebSocketCommand(command) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            toastr.error('ç³»ç»Ÿæœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return false;
        }
        
        if (!isConnected) {
            toastr.error('æ¡¥æ¥å™¨æœªè¿æ¥ï¼Œè¯·ç¡®è®¤æœ¬åœ°æ¡¥æ¥å™¨æ­£åœ¨è¿è¡Œ');
            return false;
        }
        
        try {
            ws.send(JSON.stringify(command));
            return true;
        } catch (e) {
            toastr.error('å‘½ä»¤å‘é€å¤±è´¥: ' + e.message);
            return false;
        }
    }

    // åˆå§‹åŒ–å‘¼å¸æ•°æ®å›¾è¡¨
    function initBreathChart() {
        const ctx = document.getElementById('breathChart').getContext('2d');
        breathChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'å‘¼å¸æ•°å€¼',
                    data: chartData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'å®æ—¶å‘¼å¸æ•°æ®ç›‘æµ‹'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'å‘¼å¸æ•°å€¼'
                        }
                    }
                }
            }
        });
    }

    // æ›´æ–°å›¾è¡¨æ•°æ®
    function updateBreathChart(timestamp, value) {
        const timeStr = new Date(timestamp).toLocaleTimeString();
        
        chartLabels.push(timeStr);
        chartData.push(value);
        
        const maxPoints = 50;
        if (chartData.length > maxPoints) {
            chartData.shift();
            chartLabels.shift();
        }
        
        breathChart.data.labels = chartLabels;
        breathChart.data.datasets[0].data = chartData;
        breathChart.update('none');
    }

    // è®­ç»ƒå€’è®¡æ—¶ - ä¿®å¤é—ªçƒé—®é¢˜
    function startTrainingCountdown() {
        let remainingTime = 60;
        const progressBar = document.getElementById('trainingProgress');
        const countdownSpan = document.getElementById('trainingCountdown');
        
        // ç«‹å³æ›´æ–°ä¸€æ¬¡
        progressBar.style.width = '0%';
        countdownSpan.textContent = 'å‰©ä½™æ—¶é—´: 60ç§’';
        
        trainingCountdownTimer = setInterval(function() {
            remainingTime--;
            const progress = ((60 - remainingTime) / 60) * 100;
            
            progressBar.style.width = progress + '%';
            countdownSpan.textContent = 'å‰©ä½™æ—¶é—´: ' + remainingTime + 'ç§’';
            
            if (remainingTime <= 0) {
                clearInterval(trainingCountdownTimer);
                countdownSpan.textContent = 'è®­ç»ƒå³å°†ç»“æŸ...';
                
                // è‡ªåŠ¨å‘é€åœæ­¢å‘½ä»¤
                setTimeout(function() {
                    if (isTraining) {
                        sendWebSocketCommand({ command: 'stop_training' });
                        toastr.warning('è®­ç»ƒæ—¶é—´å·²åˆ°ï¼Œè‡ªåŠ¨ç»“æŸè®­ç»ƒ');
                    }
                }, 1000);
            }
        }, 1000);
    }

    function stopTrainingCountdown() {
        if (trainingCountdownTimer) {
            clearInterval(trainingCountdownTimer);
            trainingCountdownTimer = null;
        }
    }

    // é¡µé¢åˆå§‹åŒ–
    $(document).ready(function() {
        // åˆå§‹åŒ–å›¾è¡¨
        initBreathChart();
        
        // åˆå§‹åŒ–WebSocketè¿æ¥
        initWebSocket();
        
        // è®­ç»ƒæ¨¡å¼æŒ‰é’®
        $('#trainingBtn').click(function() {
            const btn = $(this);
            
            if (!isConnected) {
                toastr.error('æ¡¥æ¥å™¨æœªè¿æ¥ï¼Œè¯·ç¡®è®¤æœ¬åœ°æ¡¥æ¥å™¨æ­£åœ¨è¿è¡Œ');
                return;
            }
            
            if (btn.data('training')) {
                console.log('å‘é€åœæ­¢è®­ç»ƒå‘½ä»¤'); // è°ƒè¯•æ—¥å¿—
                sendWebSocketCommand({ command: 'stop_training' });
                return;
            }
            
            console.log('å‘é€å¯åŠ¨è®­ç»ƒå‘½ä»¤'); // è°ƒè¯•æ—¥å¿—
            const success = sendWebSocketCommand({ command: 'start_training' });
            
            if (success) {
                console.log('è®­ç»ƒå‘½ä»¤å‘é€æˆåŠŸï¼Œç­‰å¾…æœåŠ¡å™¨å“åº”...'); // è°ƒè¯•æ—¥å¿—
                // æ¸…ç©ºå›¾è¡¨æ•°æ®
                chartData = [];
                chartLabels = [];
                breathChart.data.labels = chartLabels;
                breathChart.data.datasets[0].data = chartData;
                breathChart.update();
            } else {
                console.error('è®­ç»ƒå‘½ä»¤å‘é€å¤±è´¥'); // è°ƒè¯•æ—¥å¿—
            }
        });
        
        // ç›‘æµ‹æ¨¡å¼æŒ‰é’®
        $('#monitoringBtn').click(function() {
            const btn = $(this);
            
            if (!isConnected) {
                toastr.error('æ¡¥æ¥å™¨æœªè¿æ¥ï¼Œè¯·ç¡®è®¤æœ¬åœ°æ¡¥æ¥å™¨æ­£åœ¨è¿è¡Œ');
                return;
            }
            
            if (btn.data('monitoring')) {
                sendWebSocketCommand({ command: 'stop_monitoring' });
            } else {
                sendWebSocketCommand({ command: 'start_monitoring' });
                
                // æ¸…ç©ºå›¾è¡¨æ•°æ®
                chartData = [];
                chartLabels = [];
                breathChart.data.labels = chartLabels;
                breathChart.data.datasets[0].data = chartData;
                breathChart.update();
            }
        });
    });
</script>
{% endblock %}
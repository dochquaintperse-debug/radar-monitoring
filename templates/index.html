{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h3>🎯 专注状态实时监测</h3>
    </div>
    <div class="card-body" style="padding: 30px;">
        
        <!-- GitHub 链接提示 -->
        <div class="alert alert-info">
            <h5>📦 获取桥接器程序</h5>
            <p>请访问我们的GitHub仓库下载桥接器：</p>
            <a href="https://github.com/yourusername/radar-bridge" 
               class="btn btn-primary" target="_blank">
                📥 前往 GitHub 下载
            </a>
            <p class="mt-2 mb-0">
                <small>运行桥接器后，输入本网站地址进行连接</small>
            </p>
        </div>
        
        <!-- 连接状态 -->
        <div class="alert alert-info">
            <span class="status-indicator" id="statusIndicator"></span>
            <span id="statusText">等待桥接器连接...</span>
        </div>
        
        <!-- 监测按钮和状态 -->
        <div style="text-align: center; margin: 30px 0;">
            <button id="monitoringBtn" class="btn btn-primary btn-lg" disabled>
                🔍 开始专注监测
            </button>
            <div id="monitoringStatus" style="margin-top: 15px; display: none;">
                <div class="alert alert-warning">
                    <span id="statusMessage">正在启动监测...</span>
                </div>
            </div>
        </div>
        
        <!-- 实时图表 -->
        <div class="card">
            <div class="card-header">
                <h4>📊 呼吸数据实时图表</h4>
            </div>
            <div class="card-body">
                <div style="height: 400px;">
                    <canvas id="breathChart"></canvas>
                </div>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let breathChart;
    let chartData = [];
    let chartLabels = [];
    let ws = null;
    let isConnected = false;
    let isMonitoring = false;
    let connectionTimeout = null;

    // WebSocket连接
    function initWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + '//' + window.location.host + '/ws/radar/';
        
        ws = new WebSocket(wsUrl);
        
        ws.onopen = function() {
            console.log('WebSocket连接成功');
            updateStatus('connected', 'WebSocket已连接，等待数据...');
        };

        ws.onclose = function() {
            updateStatus('disconnected', 'WebSocket已断开');
            isConnected = false;
            document.getElementById('monitoringBtn').disabled = true;
            setTimeout(initWebSocket, 3000);
        };

        ws.onerror = function(error) {
            console.error('WebSocket错误:', error);
            updateStatus('disconnected', 'WebSocket连接失败');
        };

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            switch(data.type) {
                case 'radar_data':
                    handleRadarData(data);
                    break;
                case 'monitoring_started':
                    isMonitoring = true;
                    document.getElementById('monitoringBtn').textContent = '⏹ 停止监测';
                    document.getElementById('monitoringStatus').style.display = 'block';
                    document.getElementById('statusMessage').textContent = data.message;
                    break;
                case 'monitoring_stopped':
                    isMonitoring = false;
                    document.getElementById('monitoringBtn').textContent = '🔍 开始专注监测';
                    document.getElementById('monitoringStatus').style.display = 'none';
                    break;
                case 'show_cloud':
                    showFocusCloud(data);
                    break;
                case 'error_message':
                    console.error('收到错误:', data.message);
                    alert('错误: ' + data.message);
                    break;
            }
        };
    }

    // 处理雷达数据
    function handleRadarData(data) {
        if (!isConnected) {
            isConnected = true;
            updateStatus('connected', '桥接器已连接 - 数据正常');
            document.getElementById('monitoringBtn').disabled = false;
        }
        
        // 重置连接超时
        if (connectionTimeout) {
            clearTimeout(connectionTimeout);
        }
        
        // 设置30秒超时检测
        connectionTimeout = setTimeout(() => {
            if (isConnected) {
                isConnected = false;
                updateStatus('disconnected', '数据连接超时');
                document.getElementById('monitoringBtn').disabled = true;
            }
        }, 30000);
        
        updateChart(data.timestamp, data.value);
    }

    // 更新状态显示
    function updateStatus(status, text) {
        const indicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        
        indicator.className = `status-indicator status-${status}`;
        statusText.textContent = text;
    }

    // 更新图表
    function updateChart(timestamp, value) {
        const timeStr = new Date().toLocaleTimeString();
        
        chartLabels.push(timeStr);
        chartData.push(value);
        
        // 保持最多50个数据点
        if (chartData.length > 50) {
            chartData.shift();
            chartLabels.shift();
        }
        
        breathChart.data.labels = chartLabels;
        breathChart.data.datasets[0].data = chartData;
        breathChart.update('none');
    }

    // 显示专注云朵 - 增强版本
    function showFocusCloud(data) {
        const cloud = document.getElementById('focusCloud');
        cloud.className = 'cloud show';
        
        console.log(`检测到专注状态! 数据点: ${data.data_count}`);
        
        // 5秒后隐藏
        setTimeout(() => {
            cloud.className = 'cloud hide';
        }, 5000);
        
        // 可选：播放提示音
        try {
            const audio = new Audio('/static/js/focus-sound.mp3');
            audio.play().catch(e => console.log('音频播放失败:', e));
        } catch (e) {
            console.log('音频文件不存在');
        }
    }

    // 初始化图表
    function initChart() {
        const ctx = document.getElementById('breathChart').getContext('2d');
        breathChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: '呼吸数值',
                    data: chartData,
                    borderColor: '#FFD700',
                    backgroundColor: 'rgba(255, 215, 0, 0.1)',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: true,
                    pointRadius: 2,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 0 // 禁用动画提高性能
                },
                plugins: {
                    title: {
                        display: true,
                        text: '实时呼吸数据监测',
                        color: '#8B4513',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        labels: {
                            color: '#8B4513'
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: '#DEB887' },
                        ticks: { color: '#8B4513' }
                    },
                    x: {
                        grid: { color: '#DEB887' },
                        ticks: { 
                            color: '#8B4513',
                            maxTicksLimit: 10 // 限制X轴标签数量
                        }
                    }
                }
            }
        });
    }

    // 页面初始化
    document.addEventListener('DOMContentLoaded', function() {
        initChart();
        initWebSocket();
        
        // 监测按钮事件
        document.getElementById('monitoringBtn').addEventListener('click', function() {
            if (!isConnected) {
                alert('请先连接桥接器！');
                return;
            }
            
            if (!isMonitoring) {
                ws.send(JSON.stringify({ command: 'start_monitoring' }));
            } else {
                ws.send(JSON.stringify({ command: 'stop_monitoring' }));
            }
        });
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3>雷达数据监控</h3>
            </div>
            <div class="card-body">
                <!-- 云端环境提示 -->
                <div class="alert alert-info" role="alert">
                    <h5><i class="fas fa-info-circle"></i> 云端部署环境</h5>
                    <p>当前运行在云端，无法直接访问本地串口设备。</p>
                    <p><strong>使用方法：</strong></p>
                    <ol>
                        <li>在本地电脑下载并运行桥接器程序</li>
                        <li>桥接器会自动将雷达数据发送到此界面</li>
                        <li>在此界面查看实时数据和训练结果</li>
                    </ol>
                    <div class="bg-dark text-success p-2 rounded">
                        <code>python local_bridge_standalone.py</code>
                    </div>
                </div>
                
                <!-- 模式控制按钮 -->
                <div class="mb-3">
                    <div class="d-flex gap-2">
                        <button id="trainingBtn" class="btn btn-primary btn-lg">训练模式</button>
                        <button id="monitoringBtn" class="btn btn-success btn-lg">监测模式</button>
                    </div>
                </div>
                
                <!-- 训练状态显示 -->
                <div id="trainingStatus" style="display: none; margin-bottom: 20px;">
                    <div class="alert alert-warning" role="alert">
                        <strong>训练进行中...</strong>
                        <div class="progress mt-2">
                            <div id="trainingProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <span id="trainingCountdown">剩余时间: 60秒</span>
                    </div>
                </div>
                
                <!-- 实时图表 -->
                <h4>呼吸数据实时图表</h4>
                <div style="height: 300px; margin-bottom: 20px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                    <canvas id="breathChart"></canvas>
                </div>
                
                <!-- 实时数据列表 -->
                <h4>实时数据</h4>
                <div class="data-container">
                    <ul id="realtime-data" class="list-group">
                        <li class="list-group-item text-muted">等待本地桥接器数据...</li>
                    </ul>
                </div>
                
                <!-- 传感器状态 -->
                <div class="mt-3">
                    <h4>传感器状态</h4>
                    <div id="sensorStatus">
                        {% if sensors %}
                            {% for sensor in sensors %}
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h5 class="card-title">{{ sensor.display_name }}</h5>
                                    {% if sensor.latest_training %}
                                        <p class="card-text">平均值: {{ sensor.latest_training.average_value|floatformat:2 }}</p>
                                        <p class="card-text text-muted">{{ sensor.latest_training.created_at }}</p>
                                        <p class="card-text">
                                            最新数值: 
                                            <span id="latest-value-{{ sensor.id }}" class="badge badge-info">--</span>
                                        </p>
                                    {% else %}
                                        <p class="card-text text-warning">未训练</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">暂无传感器数据，请确认本地桥接器正在运行</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3>训练结果</h3>
            </div>
            <div class="card-body">
                <div id="trainingResults">
                    {% if sensors %}
                        {% for sensor in sensors %}
                            {% if sensor.latest_training %}
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ sensor.display_name }}</h5>
                                        <p class="card-text">平均值: {{ sensor.latest_training.average_value|floatformat:2 }}</p>
                                        <p class="card-text text-muted">{{ sensor.latest_training.created_at }}</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">暂无训练结果</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let breathChart;
    let chartData = [];
    let chartLabels = [];
    let trainingTimer = null;
    let trainingCountdownTimer = null;
    let ws = null;
    
    // WebSocket连接初始化
    function initWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + '//' + window.location.host + '/ws/radar/';
        
        console.log('连接WebSocket: ' + wsUrl);
        
        try {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                console.log('WebSocket连接成功');
                toastr.success('系统连接成功');
            };

            ws.onclose = function(event) {
                console.log('WebSocket连接关闭');
                if (!event.wasClean) {
                    toastr.warning('连接断开，3秒后重试...');
                    setTimeout(initWebSocket, 3000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket错误:', error);
                toastr.error('系统连接失败');
            };
            
            // 消息处理
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                switch(data.type) {
                    case 'training_started':
                        toastr.info(data.message);
                        $('#trainingStatus').show();
                        startTrainingCountdown();
                        
                        trainingTimer = setTimeout(function() {
                            sendWebSocketCommand({ command: 'stop_training' });
                            toastr.warning('训练时间已到，自动结束训练');
                        }, 60000);
                        break;

                    case 'radar_data':
                        updateRealtimeData(data);
                        updateSensorStatus(data);
                        updateBreathChart(data.timestamp, data.value);
                        break;
                        
                    case 'training_complete':
                        handleTrainingComplete(data);
                        break;

                    case 'monitoring_started':
                        $('#monitoringBtn').text('停止监测').removeClass('btn-success').addClass('btn-danger');
                        $('#monitoringBtn').data('monitoring', true);
                        toastr.info('监测已开始');
                        break;

                    case 'monitoring_stopped':
                        $('#monitoringBtn').text('监测模式').removeClass('btn-danger').addClass('btn-success');
                        $('#monitoringBtn').data('monitoring', false);
                        toastr.info('已停止监测');
                        break;

                    case 'anomaly_detected':
                        handleAnomalyDetection(data);
                        break;
                        
                    case 'error_message':
                        toastr.error(data.message);
                        break;
                }
            };
            
        } catch (error) {
            console.error('WebSocket初始化失败:', error);
            toastr.error('系统连接失败，请刷新页面重试');
        }
    }
    
    // 更新实时数据列表
    function updateRealtimeData(data) {
        const dataList = document.getElementById('realtime-data');
        
        if (dataList.children.length === 1 && dataList.children[0].textContent.includes('等待')) {
            dataList.innerHTML = '';
        }
        
        const newItem = document.createElement('li');
        newItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        
        const timeStr = new Date(data.timestamp).toLocaleTimeString();
        newItem.innerHTML = '<div>' +
            '<strong>传感器 ' + data.sensor_id + '</strong>: ' + data.value + ' ' +
            '<small class="text-muted">(' + data.hex_value + ')</small>' +
            '</div>' +
            '<small class="text-muted">' + timeStr + '</small>';
        
        dataList.insertBefore(newItem, dataList.firstChild);

        // 限制显示条数
        while (dataList.children.length > 20) {
            dataList.removeChild(dataList.lastChild);
        }
    }
    
    // 更新传感器状态
    function updateSensorStatus(data) {
        const sensorIdNum = data.sensor_id.replace(/\D/g, '');
        const latestValueElem = document.getElementById('latest-value-' + sensorIdNum);
        if (latestValueElem) {
            latestValueElem.textContent = data.value;
            latestValueElem.className = 'badge badge-success';
            
            setTimeout(function() {
                latestValueElem.className = 'badge badge-info';
            }, 3000);
        }
    }
    
    // 处理训练完成
    function handleTrainingComplete(data) {
        toastr.success('传感器 ' + data.sensor_id + ' 训练完成，平均值: ' + data.average_value.toFixed(2));
        
        if (trainingTimer) {
            clearTimeout(trainingTimer);
            trainingTimer = null;
        }
        stopTrainingCountdown();
        
        $('#trainingBtn').prop('disabled', false).text('训练模式').data('training', false);
        $('#monitoringBtn').prop('disabled', false);
        $('#trainingStatus').hide();
        
        setTimeout(function() {
            location.reload();
        }, 2000);
    }
    
    // 处理异常检测
    function handleAnomalyDetection(data) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger position-fixed';
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = '<strong>异常警告!</strong><br>' +
            '传感器 ' + data.sensor_id + ' 检测到异常<br>' +
            '异常值: ' + data.values.join(', ') + '<br>' +
            '基准值: ' + data.average.toFixed(2);
        document.body.appendChild(alertDiv);
        
        setTimeout(function() {
            alertDiv.remove();
        }, 5000);
        
        toastr.error('检测到呼吸异常！');
    }

    // 发送WebSocket命令
    function sendWebSocketCommand(command) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            toastr.error('系统未连接，请刷新页面重试');
            return false;
        }
        try {
            ws.send(JSON.stringify(command));
            return true;
        } catch (e) {
            toastr.error('命令发送失败: ' + e.message);
            return false;
        }
    }

    // 初始化呼吸数据图表
    function initBreathChart() {
        const ctx = document.getElementById('breathChart').getContext('2d');
        breathChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: '呼吸数值',
                    data: chartData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: '实时呼吸数据监测'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '呼吸数值'
                        }
                    }
                }
            }
        });
    }

    // 更新图表数据
    function updateBreathChart(timestamp, value) {
        const timeStr = new Date(timestamp).toLocaleTimeString();
        
        chartLabels.push(timeStr);
        chartData.push(value);
        
        const maxPoints = 50;
        if (chartData.length > maxPoints) {
            chartData.shift();
            chartLabels.shift();
        }
        
        breathChart.data.labels = chartLabels;
        breathChart.data.datasets[0].data = chartData;
        breathChart.update('none');
    }

    // 训练倒计时
    function startTrainingCountdown() {
        let remainingTime = 60;
        const progressBar = document.getElementById('trainingProgress');
        const countdownSpan = document.getElementById('trainingCountdown');
        
        trainingCountdownTimer = setInterval(function() {
            remainingTime--;
            const progress = ((60 - remainingTime) / 60) * 100;
            
            progressBar.style.width = progress + '%';
            countdownSpan.textContent = '剩余时间: ' + remainingTime + '秒';
            
            if (remainingTime <= 0) {
                clearInterval(trainingCountdownTimer);
                countdownSpan.textContent = '训练即将结束...';
            }
        }, 1000);
    }

    function stopTrainingCountdown() {
        if (trainingCountdownTimer) {
            clearInterval(trainingCountdownTimer);
            trainingCountdownTimer = null;
        }
    }

    // 页面初始化
    $(document).ready(function() {
        // 初始化图表
        initBreathChart();
        
        // 初始化WebSocket连接
        initWebSocket();
        
        // 训练模式按钮
        $('#trainingBtn').click(function() {
            const btn = $(this);
            if (btn.data('training')) {
                sendWebSocketCommand({ command: 'stop_training' });
                
                if (trainingTimer) {
                    clearTimeout(trainingTimer);
                    trainingTimer = null;
                }
                stopTrainingCountdown();
                
                btn.text('训练模式').data('training', false);
                $('#trainingStatus').hide();
                toastr.info('已手动停止训练');
                return;
            }
            
            sendWebSocketCommand({ command: 'start_training' });
            btn.data('training', true).text('停止训练');
            $('#monitoringBtn').prop('disabled', true);
            
            // 清空图表数据
            chartData = [];
            chartLabels = [];
            breathChart.data.labels = chartLabels;
            breathChart.data.datasets[0].data = chartData;
            breathChart.update();
        });
        
        // 监测模式按钮
        $('#monitoringBtn').click(function() {
            const btn = $(this);
            if (btn.data('monitoring')) {
                sendWebSocketCommand({ command: 'stop_monitoring' });
            } else {
                sendWebSocketCommand({ command: 'start_monitoring' });
                
                // 清空图表数据
                chartData = [];
                chartLabels = [];
                breathChart.data.labels = chartLabels;
                breathChart.data.datasets[0].data = chartData;
                breathChart.update();
            }
        });
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3>é›·è¾¾æ•°æ®ç›‘æ§</h3>
            </div>
            <div class="card-body">
                <!-- ä¸²å£æ‰«æçŠ¶æ€ -->
                <div class="alert alert-info" role="alert">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-search"></i> ä¸²å£çŠ¶æ€:
                            <span id="portStatus">æœªè¿æ¥</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex gap-2 flex-wrap">
                        <button id="refreshPortsBtn" class="btn btn-outline-secondary">
                            åˆ·æ–°ä¸²å£
                        </button>
                        <button id="openPortBtn" class="btn btn-outline-primary">
                            æ‰“å¼€ä¸²å£
                        </button>
                    </div>
                </div>
                
                <!-- ä¸²å£åˆ—è¡¨ -->
                <div class="mb-3" id="portsList" style="display: none;">
                    <label class="form-label">å¯ç”¨ä¸²å£:</label>
                    <div class="list-group" id="availablePorts">
                        <!-- ä¸²å£åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
                
                <!-- æ¨¡å¼æŒ‰é’® -->
                <div class="button-container">
                    <button id="trainingBtn" class="btn btn-primary btn-lg mr-3" disabled>è®­ç»ƒæ¨¡å¼</button>
                    <button id="monitoringBtn" class="btn btn-success btn-lg" disabled>ç›‘æµ‹æ¨¡å¼</button>
                </div>
                
                <!-- è®­ç»ƒçŠ¶æ€æ˜¾ç¤º -->
                <div id="trainingStatus" style="display: none; margin-bottom: 20px;">
                    <div class="alert alert-warning" role="alert">
                        <strong>è®­ç»ƒè¿›è¡Œä¸­...</strong>
                        <div class="progress mt-2">
                            <div id="trainingProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <span id="trainingCountdown">å‰©ä½™æ—¶é—´: 60ç§’</span>
                    </div>
                </div>
                
                <h4>å‘¼å¸æ•°æ®å®æ—¶å›¾è¡¨</h4>
                <!-- å›¾è¡¨å®¹å™¨ -->
                <div style="height: 300px; margin-bottom: 20px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                    <canvas id="breathChart"></canvas>
                </div>
                
                <h4>å®æ—¶æ•°æ®</h4>
                <div class="data-container">
                    <ul id="realtime-data" class="list-group">
                        <li class="list-group-item text-muted">ç­‰å¾…æ•°æ®...</li>
                    </ul>
                </div>
                
                <div class="mt-3">
                    <h4>ä¼ æ„Ÿå™¨çŠ¶æ€</h4>
                    <div id="sensorStatus">
                        {% if sensors %}
                            {% for sensor in sensors %}
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h5 class="card-title">{{ sensor.display_name }}</h5>
                                    {% if sensor.latest_training %}
                                        <p class="card-text">å¹³å‡å€¼: {{ sensor.latest_training.average_value|floatformat:2 }}</p>
                                        <p class="card-text text-muted">{{ sensor.latest_training.created_at }}</p>
                                        <p class="card-text">
                                            æœ€æ–°æ•°å€¼: 
                                            <span id="latest-value-{{ sensor.id }}" class="badge badge-info">--</span>
                                        </p>
                                    {% else %}
                                        <p class="card-text text-warning">æœªè®­ç»ƒ</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p>æ²¡æœ‰å¯ç”¨çš„ä¼ æ„Ÿå™¨</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3>è®­ç»ƒç»“æœ</h3>
            </div>
            <div class="card-body">
                <div id="trainingResults">
                    {% if sensors %}
                        {% for sensor in sensors %}
                            {% if sensor.latest_training %}
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ sensor.display_name }}</h5>
                                        <p class="card-text">å¹³å‡å€¼: {{ sensor.latest_training.average_value|floatformat:2 }}</p>
                                        <p class="card-text text-muted">{{ sensor.latest_training.created_at }}</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <p>æ²¡æœ‰è®­ç»ƒç»“æœ</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
    if ('serial' in navigator) {
        console.log('âœ… æµè§ˆå™¨æ”¯æŒ Web Serial API');
        $('#webSerialSupport').show();
    } else {
        console.log('âŒ æµè§ˆå™¨ä¸æ”¯æŒ Web Serial API');
        $('#webSerialFallback').show();
    }

    // Web Serial API è¿æ¥å‡½æ•°
    let serialPort = null;
    let serialReader = null;

    async function connectWebSerial() {
        try {
            // è¯·æ±‚ç”¨æˆ·é€‰æ‹©ä¸²å£
            serialPort = await navigator.serial.requestPort({
                filters: [
                    { usbVendorId: 0x10c4 }, // Silicon Labs CP210x
                    { usbVendorId: 0x0403 }, // FTDI
                    { usbVendorId: 0x067b }  // Prolific
                ]
            });
            
            // æ‰“å¼€ä¸²å£
            await serialPort.open({
                baudRate: 115200,
                dataBits: 8,
                stopBits: 1,
                parity: 'none'
            });
            
            toastr.success('ğŸ‰ ç›´æ¥ä¸²å£è¿æ¥æˆåŠŸï¼');
            $('#portStatus').text('å·²è¿æ¥: Web Serial API');
            $('#trainingBtn').prop('disabled', false);
            $('#monitoringBtn').prop('disabled', false);
            
            // å¼€å§‹è¯»å–æ•°æ®
            startWebSerialReading();
            
        } catch (err) {
            toastr.error(`è¿æ¥å¤±è´¥: ${err.message}`);
            console.error('Web Serialè¿æ¥é”™è¯¯:', err);
        }
    }

    // R60ABD1åè®®è§£æ
    function parseR60ABD1Frame(data) {
        const frame = new Uint8Array(data);
        
        // æ£€æŸ¥å¸§å¤´ 0x53 0x59
        if (frame.length >= 10 && frame[0] === 0x53 && frame[1] === 0x59) {
            // æ£€æŸ¥å‘¼å¸æ•°æ®å¸§ (81 82 00 01)
            if (frame[2] === 0x81 && frame[3] === 0x82 && 
                frame[4] === 0x00 && frame[5] === 0x01) {
                
                const value = frame[6]; // å‘¼å¸æ•°å€¼
                const hexValue = `0x${value.toString(16).toUpperCase().padStart(2, '0')}`;
                
                return {
                    sensor_id: 'R60ABD1_BREATH_WEB',
                    value: value,
                    hex_value: hexValue,
                    timestamp: new Date().toISOString()
                };
            }
        }
        return null;
    }

    // è¯»å–ä¸²å£æ•°æ®
    async function startWebSerialReading() {
        if (!serialPort || !serialPort.readable) return;
        
        serialReader = serialPort.readable.getReader();
        
        try {
            while (true) {
                const { value, done } = await serialReader.read();
                if (done) break;
                
                // è§£æé›·è¾¾æ•°æ®
                const parsed = parseR60ABD1Frame(value);
                if (parsed) {
                    console.log('ğŸ¯ è§£æåˆ°é›·è¾¾æ•°æ®:', parsed);
                    
                    // ç›´æ¥å¤„ç†æ•°æ®ï¼ˆä¸éœ€è¦WebSocketï¼‰
                    processDirectRadarData(parsed);
                }
            }
        } catch (error) {
            console.error('è¯»å–ä¸²å£æ•°æ®é”™è¯¯:', error);
        } finally {
            if (serialReader) {
                serialReader.releaseLock();
            }
        }
    }

    // ç›´æ¥å¤„ç†é›·è¾¾æ•°æ®
    function processDirectRadarData(data) {
        // æ›´æ–°å®æ—¶æ•°æ®åˆ—è¡¨
        const dataList = document.getElementById('realtime-data');
        if (dataList.children.length === 1 && dataList.children[0].textContent === 'ç­‰å¾…æ•°æ®...') {
            dataList.innerHTML = '';
        }
        
        const newItem = document.createElement('li');
        newItem.className = 'list-group-item d-flex justify-content-between align-items-center';
        const timeStr = new Date(data.timestamp).toLocaleTimeString();
        newItem.innerHTML = `
            <div>
                <strong>ğŸŒ Webä¸²å£</strong>: ${data.value} 
                <small class="text-muted">(${data.hex_value})</small>
            </div>
            <small class="text-muted">${timeStr}</small>
        `;
        
        dataList.insertBefore(newItem, dataList.firstChild);
        while (dataList.children.length > 20) {
            dataList.removeChild(dataList.lastChild);
        }
        
        // æ›´æ–°å›¾è¡¨
        updateBreathChart(data.timestamp, data.value);
        
        // å‘é€åˆ°åç«¯ä¿å­˜ï¼ˆå¯é€‰ï¼‰
        fetch('/api/web-serial-data', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        }).catch(err => console.log('å‘é€åˆ°åç«¯å¤±è´¥:', err));
    }

    // å‘é€æŸ¥è¯¢å‘½ä»¤åˆ°è®¾å¤‡
    async function sendRadarCommand() {
        if (!serialPort || !serialPort.writable) {
            console.log('ä¸²å£ä¸å¯å†™å…¥');
            return;
        }
        
        const writer = serialPort.writable.getWriter();
        try {
            // R60ABD1å‘¼å¸æŸ¥è¯¢å‘½ä»¤: 53 59 81 82 00 01 0F BF 54 43
            const command = new Uint8Array([0x53, 0x59, 0x81, 0x82, 0x00, 0x01, 0x0F, 0xBF, 0x54, 0x43]);
            await writer.write(command);
            console.log('âœ… å·²å‘é€æŸ¥è¯¢å‘½ä»¤');
        } finally {
            writer.releaseLock();
        }
    }

    // å®šæ—¶å‘é€å‘½ä»¤
    function startCommandLoop() {
        setInterval(() => {
            if (serialPort && $('#trainingBtn').data('training') || $('#monitoringBtn').data('monitoring')) {
                sendRadarCommand();
            }
        }, 1000); // æ¯ç§’å‘é€ä¸€æ¬¡
    }
    </script>

    <!-- æ·»åŠ Web Serialè¿æ¥æŒ‰é’® -->
    <div id="webSerialSupport" style="display: none;" class="mb-3">
        <div class="alert alert-success" role="alert">
            <i class="fas fa-usb"></i> 
            <strong>æ”¯æŒç›´æ¥ä¸²å£è¿æ¥ï¼</strong> 
            æ‚¨çš„æµè§ˆå™¨æ”¯æŒç›´æ¥è®¿é—®USBä¸²å£è®¾å¤‡
        </div>
        <button id="webSerialBtn" class="btn btn-success" onclick="connectWebSerial()">
            ğŸ”Œ è¿æ¥R60ABD1è®¾å¤‡
        </button>
    </div>

    <div id="webSerialFallback" style="display: none;" class="mb-3">
        <div class="alert alert-warning" role="alert">
            <i class="fas fa-exclamation-triangle"></i> 
            <strong>æµè§ˆå™¨ä¸æ”¯æŒç›´æ¥ä¸²å£è¿æ¥</strong><br>
            è¯·ä½¿ç”¨ <strong>Chrome 89+</strong> æˆ– <strong>Edge 89+</strong> æµè§ˆå™¨
        </div>
    </div>

    let breathChart;
    let chartData = [];
    let chartLabels = [];
    let trainingTimer = null; // è®­ç»ƒå®šæ—¶å™¨
    let trainingCountdownTimer = null; // å€’è®¡æ—¶å®šæ—¶å™¨
    
    // åˆå§‹åŒ–å‘¼å¸æ•°æ®å›¾è¡¨
    function initBreathChart() {
        const ctx = document.getElementById('breathChart').getContext('2d');
        breathChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'å‘¼å¸æ•°å€¼',
                    data: chartData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: 'rgb(75, 192, 192)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'å®æ—¶å‘¼å¸æ•°æ®ç›‘æµ‹'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'å‘¼å¸æ•°å€¼'
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'æ—¶é—´'
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                },
                animation: {
                    duration: 200 // å¿«é€ŸåŠ¨ç”»
                },
                interaction: {
                    intersect: false,
                    mode: 'index',
                }
            }
        });
    }

    // æ›´æ–°å›¾è¡¨æ•°æ®çš„å‡½æ•°
    function updateBreathChart(timestamp, value) {
        const timeStr = new Date(timestamp).toLocaleTimeString();
        
        // æ·»åŠ æ–°æ•°æ®ç‚¹
        chartLabels.push(timeStr);
        chartData.push(value);
        
        // ä¿æŒæœ€å¤§50ä¸ªæ•°æ®ç‚¹
        const maxPoints = 50;
        if (chartData.length > maxPoints) {
            chartData.shift();
            chartLabels.shift();
        }
        
        // æ›´æ–°å›¾è¡¨
        breathChart.data.labels = chartLabels;
        breathChart.data.datasets[0].data = chartData;
        breathChart.update('none'); // ä¸ä½¿ç”¨åŠ¨ç”»ä»¥æé«˜æ€§èƒ½
    }

    // å¯åŠ¨è®­ç»ƒå€’è®¡æ—¶
    function startTrainingCountdown() {
        let remainingTime = 60;
        const progressBar = document.getElementById('trainingProgress');
        const countdownSpan = document.getElementById('trainingCountdown');
        
        trainingCountdownTimer = setInterval(() => {
            remainingTime--;
            const progress = ((60 - remainingTime) / 60) * 100;
            
            progressBar.style.width = `${progress}%`;
            countdownSpan.textContent = `å‰©ä½™æ—¶é—´: ${remainingTime}ç§’`;
            
            if (remainingTime <= 0) {
                clearInterval(trainingCountdownTimer);
                countdownSpan.textContent = 'è®­ç»ƒå³å°†ç»“æŸ...';
            }
        }, 1000);
    }

    // åœæ­¢è®­ç»ƒå€’è®¡æ—¶
    function stopTrainingCountdown() {
        if (trainingCountdownTimer) {
            clearInterval(trainingCountdownTimer);
            trainingCountdownTimer = null;
        }
    }

    // åˆå§‹åŒ–å›¾è¡¨
    initBreathChart();
    
    // WebSocketè¿æ¥
    const ws = new WebSocket('ws://' + window.location.host + '/ws/radar/');
    let portOpened = false;

    function sendWebSocketCommand(command) {
        if (ws.readyState !== WebSocket.OPEN) {
            toastr.error('WebSocketæœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return false;
        }
        try {
            ws.send(JSON.stringify(command));
            return true;
        } catch (e) {
            toastr.error(`å‘½ä»¤å‘é€å¤±è´¥: ${e.message}`);
            setTimeout(() => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(command));
                }
            }, 1000);
            return false;
        }
    }

    // è¿æ¥çŠ¶æ€æ›´æ–°
    ws.onopen = function() {
        document.getElementById('statusIndicator').className = 'connected';
        document.getElementById('connectionStatus').textContent = 'è¿æ¥çŠ¶æ€ï¼šå·²è¿æ¥';
        toastr.success('WebSocketè¿æ¥æˆåŠŸ');
    };

    ws.onclose = function() {
        document.getElementById('statusIndicator').className = 'disconnected';
        document.getElementById('connectionStatus').textContent = 'è¿æ¥çŠ¶æ€ï¼šå·²æ–­å¼€';
        toastr.error('WebSocketè¿æ¥æ–­å¼€');
    };
    
    // å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
    
        switch(data.type) {
            case 'training_started':
                toastr.info(data.message);
                $('#trainingStatus').show();
                startTrainingCountdown(); // å¯åŠ¨å€’è®¡æ—¶
                
                // è®¾ç½®60ç§’è‡ªåŠ¨ç»“æŸå®šæ—¶å™¨
                trainingTimer = setTimeout(() => {
                    // å‘é€åœæ­¢è®­ç»ƒå‘½ä»¤
                    sendWebSocketCommand({ command: 'stop_training' });
                    toastr.warning('è®­ç»ƒæ—¶é—´å·²åˆ°ï¼Œè‡ªåŠ¨ç»“æŸè®­ç»ƒ');
                }, 60000); // 60ç§’
                break;

            case 'radar_data':
                // æ›´æ–°å®æ—¶æ•°æ®åˆ—è¡¨
                const dataList = document.getElementById('realtime-data');
                
                // æ¸…é™¤"ç­‰å¾…æ•°æ®..."æç¤º
                if (dataList.children.length === 1 && dataList.children[0].textContent === 'ç­‰å¾…æ•°æ®...') {
                    dataList.innerHTML = '';
                }
                
                const newItem = document.createElement('li');
                newItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                
                const timeStr = new Date(data.timestamp).toLocaleTimeString();
                newItem.innerHTML = `
                    <div>
                        <strong>ä¼ æ„Ÿå™¨${data.sensor_id}</strong>: ${data.value} 
                        <small class="text-muted">(${data.hex_value})</small>
                    </div>
                    <small class="text-muted">${timeStr}</small>
                `;
                
                dataList.insertBefore(newItem, dataList.firstChild); // æ·»åŠ åˆ°é¡¶éƒ¨

                // æ›´æ–°ä¼ æ„Ÿå™¨æœ€æ–°å€¼æ˜¾ç¤º
                const sensorIdNum = data.sensor_id.replace(/\D/g, ''); // æå–æ•°å­—
                const latestValueElem = document.getElementById(`latest-value-${sensorIdNum}`);
                if (latestValueElem) {
                    latestValueElem.textContent = data.value;
                    latestValueElem.className = 'badge badge-success'; // æ›´æ–°æ ·å¼è¡¨ç¤ºæœ‰æ–°æ•°æ®
                    
                    // 3ç§’åæ¢å¤åŸæ ·å¼
                    setTimeout(() => {
                        latestValueElem.className = 'badge badge-info';
                    }, 3000);
                }

                // é™åˆ¶åˆ—è¡¨é•¿åº¦ä¸ºæœ€æ–°20æ¡
                while (dataList.children.length > 20) {
                    dataList.removeChild(dataList.lastChild);
                }
                
                // æ›´æ–°å‘¼å¸æ•°æ®å›¾è¡¨ï¼ˆå…³é”®ä¿®å¤ï¼‰
                updateBreathChart(data.timestamp, data.value);
                break;
                
            case 'training_complete':
                toastr.success(`ä¼ æ„Ÿå™¨ ${data.sensor_id} è®­ç»ƒå®Œæˆï¼Œå¹³å‡å€¼: ${data.average_value.toFixed(2)}`);
                
                // æ¸…é™¤å®šæ—¶å™¨
                if (trainingTimer) {
                    clearTimeout(trainingTimer);
                    trainingTimer = null;
                }
                stopTrainingCountdown();
                
                // é‡æ–°å¯ç”¨æŒ‰é’®
                $('#trainingBtn').prop('disabled', false).text('è®­ç»ƒæ¨¡å¼').data('training', false);
                $('#monitoringBtn').prop('disabled', false);
                $('#trainingStatus').hide();
                
                // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæœ€æ–°è®­ç»ƒç»“æœ
                setTimeout(() => {
                    location.reload();
                }, 1000);
                break;

            case 'monitoring_started':
                $('#monitoringBtn').text('åœæ­¢ç›‘æµ‹').removeClass('btn-success').addClass('btn-danger');
                $('#monitoringBtn').data('monitoring', true);
                toastr.info('ç›‘æµ‹å·²å¼€å§‹');
                break;

            case 'monitoring_stopped':
                $('#monitoringBtn').text('ç›‘æµ‹æ¨¡å¼').removeClass('btn-danger').addClass('btn-success');
                $('#monitoringBtn').data('monitoring', false);
                toastr.info('å·²åœæ­¢ç›‘æµ‹');
                break;

            case 'anomaly_detected':
                const alertDiv = document.createElement('div');
                alertDiv.className = 'anomaly-alert';
                alertDiv.innerHTML = `
                    <strong>å¼‚å¸¸è­¦å‘Š!</strong><br>
                    ä¼ æ„Ÿå™¨ ${data.sensor_id} æ£€æµ‹åˆ°è¿ç»­å¼‚å¸¸<br>
                    å¼‚å¸¸å€¼: ${data.values.join(', ')}<br>
                    åŸºå‡†å€¼: ${data.average.toFixed(2)}
                `;
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    alertDiv.style.opacity = '0';
                    setTimeout(() => alertDiv.remove(), 500);
                }, 5000);
                break;
                
            case 'error_message':
                toastr.error(data.message);
                break;
        }
    };
    
    // æŒ‰é’®äº‹ä»¶ç»‘å®š
    $(document).ready(function() {
        // åˆ·æ–°ä¸²å£æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#refreshPortsBtn').click(function() {
            toastr.info('æ­£åœ¨åˆ·æ–°ä¸²å£...');
            $.get('/scan-ports/', function(data) {
                const portsList = $('#availablePorts');
                portsList.empty();
                
                if (data.ports.length > 0) {
                    $('#portsList').show();
                    data.ports.forEach(port => {
                        const item = $(`
                            <a href="#" class="list-group-item list-group-item-action">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${port}</h6>
                                    <small class="text-muted">å¯ç”¨</small>
                                </div>
                                <small>ç‚¹å‡»é€‰æ‹©æ­¤ä¸²å£</small>
                            </a>
                        `);
                        item.click(function(e) {
                            e.preventDefault();
                            $('.list-group-item').removeClass('active');
                            item.addClass('active');
                            $('#availablePorts').data('selectedPort', port);
                        });
                        portsList.append(item);
                    });
                    toastr.success(`å‘ç° ${data.ports.length} ä¸ªå¯ç”¨ä¸²å£`);
                } else {
                    $('#portsList').hide();
                    toastr.warning('æœªå‘ç°å¯ç”¨ä¸²å£');
                }
            }).fail(function() {
                toastr.error('æ‰«æä¸²å£å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿæƒé™');
            });
        });
        
        // æ‰“å¼€ä¸²å£æŒ‰é’®
        $('#openPortBtn').click(function() {
            const selectedPort = $('#availablePorts').data('selectedPort');
            if (!selectedPort) {
                toastr.error('è¯·å…ˆä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªä¸²å£');
                return;
            }
            
            toastr.info(`æ­£åœ¨æ‰“å¼€ä¸²å£ ${selectedPort}...`);
            $.post('/open-port/', JSON.stringify({port: selectedPort}), function(data) {
                if (data.success) {
                    toastr.success(`ä¸²å£ ${selectedPort} å·²æ‰“å¼€`);
                    $('#portStatus').text(`å·²è¿æ¥: ${selectedPort}`);
                    portOpened = true;
                    $('#trainingBtn').prop('disabled', false);
                    $('#monitoringBtn').prop('disabled', false);
                } else {
                    toastr.error(`æ‰“å¼€ä¸²å£å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}`);
                }
            }).fail(function() {
                toastr.error('ä¸²å£è¿æ¥è¯·æ±‚å¤±è´¥');
            });
        });
        
        // è®­ç»ƒæ¨¡å¼æŒ‰é’®
        $('#trainingBtn').click(function() {
            if (!portOpened) {
                toastr.error('è¯·å…ˆæ‰“å¼€ä¸²å£');
                return;
            }
            
            const btn = $(this);
            if (btn.data('training')) {
                // æ‰‹åŠ¨åœæ­¢è®­ç»ƒ
                sendWebSocketCommand({ command: 'stop_training' });
                
                // æ¸…é™¤å®šæ—¶å™¨
                if (trainingTimer) {
                    clearTimeout(trainingTimer);
                    trainingTimer = null;
                }
                stopTrainingCountdown();
                
                btn.text('è®­ç»ƒæ¨¡å¼').data('training', false);
                $('#trainingStatus').hide();
                toastr.info('å·²æ‰‹åŠ¨åœæ­¢è®­ç»ƒ');
                return;
            }
            
            // å¼€å§‹è®­ç»ƒ
            sendWebSocketCommand({ command: 'start_training' });
            btn.prop('disabled', true).data('training', true).text('åœæ­¢è®­ç»ƒ');
            $('#monitoringBtn').prop('disabled', true);
            
            // æ¸…ç©ºå›¾è¡¨æ•°æ®ï¼Œå‡†å¤‡æ¥æ”¶æ–°çš„è®­ç»ƒæ•°æ®
            chartData = [];
            chartLabels = [];
            breathChart.data.labels = chartLabels;
            breathChart.data.datasets[0].data = chartData;
            breathChart.update();
        });
        
        // ç›‘æµ‹æ¨¡å¼æŒ‰é’®
        $('#monitoringBtn').click(function() {
            if (!portOpened) {
                toastr.error('è¯·å…ˆæ‰“å¼€ä¸²å£');
                return;
            }
            
            const btn = $(this);
            if (btn.data('monitoring')) {
                sendWebSocketCommand({ command: 'stop_monitoring' });
            } else {
                sendWebSocketCommand({ command: 'start_monitoring' });
                
                // æ¸…ç©ºå›¾è¡¨æ•°æ®ï¼Œå‡†å¤‡æ¥æ”¶æ–°çš„ç›‘æµ‹æ•°æ®
                chartData = [];
                chartLabels = [];
                breathChart.data.labels = chartLabels;
                breathChart.data.datasets[0].data = chartData;
                breathChart.update();
            }
        });
        
        // åˆå§‹åŠ è½½æ—¶åˆ·æ–°ä¸²å£
        $('#refreshPortsBtn').click();
    });
</script>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3>雷达数据监控</h3>
            </div>
            <div class="card-body">
                <!-- 串口扫描状态 -->
                <div class="alert alert-info" role="alert">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-search"></i> 串口状态:
                            <span id="portStatus">未连接</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex gap-2 flex-wrap">
                        <button id="refreshPortsBtn" class="btn btn-outline-secondary">
                            刷新串口
                        </button>
                        <button id="openPortBtn" class="btn btn-outline-primary" disabled>
                            打开串口
                        </button>
                    </div>
                </div>
                
                <!-- 串口列表 -->
                <div class="mb-3" id="portsList" style="display: none;">
                    <label class="form-label">可用串口:</label>
                    <div class="list-group" id="availablePorts">
                        <!-- 串口列表将通过JavaScript动态添加 -->
                    </div>
                </div>
                
                <!-- 模式按钮 -->
                <div class="button-container">
                    <button id="trainingBtn" class="btn btn-primary btn-lg mr-3" disabled>训练模式</button>
                    <button id="monitoringBtn" class="btn btn-success btn-lg" disabled>监测模式</button>
                </div>
                
                <!-- 训练状态显示 -->
                <div id="trainingStatus" style="display: none; margin-bottom: 20px;">
                    <div class="alert alert-warning" role="alert">
                        <strong>训练进行中...</strong>
                        <div class="progress mt-2">
                            <div id="trainingProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <span id="trainingCountdown">剩余时间: 60秒</span>
                    </div>
                </div>
                
                <h4>呼吸数据实时图表</h4>
                <div style="height: 300px; margin-bottom: 20px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                    <canvas id="breathChart"></canvas>
                </div>
                
                <h4>实时数据</h4>
                <div class="data-container">
                    <ul id="realtime-data" class="list-group">
                        <li class="list-group-item text-muted">等待数据...</li>
                    </ul>
                </div>
                
                <div class="mt-3">
                    <h4>传感器状态</h4>
                    <div id="sensorStatus">
                        {% if sensors %}
                            {% for sensor in sensors %}
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h5 class="card-title">{{ sensor.display_name }}</h5>
                                    {% if sensor.latest_training %}
                                        <p class="card-text">平均值: {{ sensor.latest_training.average_value|floatformat:2 }}</p>
                                        <p class="card-text text-muted">{{ sensor.latest_training.created_at }}</p>
                                        <p class="card-text">
                                            最新数值: 
                                            <span id="latest-value-{{ sensor.id }}" class="badge badge-info">--</span>
                                        </p>
                                    {% else %}
                                        <p class="card-text text-warning">未训练</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p>没有可用的传感器</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3>训练结果</h3>
            </div>
            <div class="card-body">
                <div id="trainingResults">
                    {% if sensors %}
                        {% for sensor in sensors %}
                            {% if sensor.latest_training %}
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ sensor.display_name }}</h5>
                                        <p class="card-text">平均值: {{ sensor.latest_training.average_value|floatformat:2 }}</p>
                                        <p class="card-text text-muted">{{ sensor.latest_training.created_at }}</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <p>没有训练结果</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let breathChart;
    let chartData = [];
    let chartLabels = [];
    let trainingTimer = null;
    let trainingCountdownTimer = null;
    let portOpened = false;
    let ws = null;
    
    // 🔧 关键修复：智能WebSocket连接
    function initWebSocket() {
        // 自动检测协议（HTTP/HTTPS对应ws/wss）
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + '//' + window.location.host + '/ws/radar/';
        
        console.log('🔗 尝试连接WebSocket: ' + wsUrl);
        
        try {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                document.getElementById('statusIndicator').className = 'connected';
                document.getElementById('connectionStatus').textContent = '连接状态：已连接';
                toastr.success('WebSocket连接成功');
                
                // 🔧 修复：连接成功后立即自动扫描串口
                setTimeout(function() {
                    autoRefreshPorts();
                }, 1000);
            };

            ws.onclose = function(event) {
                document.getElementById('statusIndicator').className = 'disconnected';
                document.getElementById('connectionStatus').textContent = '连接状态：已断开';
                
                if (event.wasClean) {
                    toastr.warning('WebSocket连接已关闭');
                } else {
                    toastr.error('WebSocket连接意外断开，3秒后重试...');
                    setTimeout(initWebSocket, 3000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocket错误:', error);
                toastr.error('WebSocket连接失败');
            };
            
            // 现有的消息处理逻辑保持不变
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                switch(data.type) {
                    case 'training_started':
                        toastr.info(data.message);
                        $('#trainingStatus').show();
                        startTrainingCountdown();
                        
                        trainingTimer = setTimeout(function() {
                            sendWebSocketCommand({ command: 'stop_training' });
                            toastr.warning('训练时间已到，自动结束训练');
                        }, 60000);
                        break;

                    case 'radar_data':
                        const dataList = document.getElementById('realtime-data');
                        
                        if (dataList.children.length === 1 && dataList.children[0].textContent === '等待数据...') {
                            dataList.innerHTML = '';
                        }
                        
                        const newItem = document.createElement('li');
                        newItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        
                        const timeStr = new Date(data.timestamp).toLocaleTimeString();
                        // 🔧 关键修复：避免模板语法冲突，使用字符串拼接
                        newItem.innerHTML = '<div>' +
                            '<strong>传感器' + data.sensor_id + '</strong>: ' + data.value + ' ' +
                            '<small class="text-muted">(' + data.hex_value + ')</small>' +
                            '</div>' +
                            '<small class="text-muted">' + timeStr + '</small>';
                        
                        dataList.insertBefore(newItem, dataList.firstChild);

                        const sensorIdNum = data.sensor_id.replace(/\D/g, '');
                        const latestValueElem = document.getElementById('latest-value-' + sensorIdNum);
                        if (latestValueElem) {
                            latestValueElem.textContent = data.value;
                            latestValueElem.className = 'badge badge-success';
                            
                            setTimeout(function() {
                                latestValueElem.className = 'badge badge-info';
                            }, 3000);
                        }

                        while (dataList.children.length > 20) {
                            dataList.removeChild(dataList.lastChild);
                        }
                        
                        updateBreathChart(data.timestamp, data.value);
                        break;
                        
                    case 'training_complete':
                        toastr.success('传感器 ' + data.sensor_id + ' 训练完成，平均值: ' + data.average_value.toFixed(2));
                        
                        if (trainingTimer) {
                            clearTimeout(trainingTimer);
                            trainingTimer = null;
                        }
                        stopTrainingCountdown();
                        
                        $('#trainingBtn').prop('disabled', false).text('训练模式').data('training', false);
                        $('#monitoringBtn').prop('disabled', false);
                        $('#trainingStatus').hide();
                        
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                        break;

                    case 'monitoring_started':
                        $('#monitoringBtn').text('停止监测').removeClass('btn-success').addClass('btn-danger');
                        $('#monitoringBtn').data('monitoring', true);
                        toastr.info('监测已开始');
                        break;

                    case 'monitoring_stopped':
                        $('#monitoringBtn').text('监测模式').removeClass('btn-danger').addClass('btn-success');
                        $('#monitoringBtn').data('monitoring', false);
                        toastr.info('已停止监测');
                        break;

                    case 'anomaly_detected':
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'anomaly-alert';
                        alertDiv.innerHTML = '<strong>异常警告!</strong><br>' +
                            '传感器 ' + data.sensor_id + ' 检测到连续异常<br>' +
                            '异常值: ' + data.values.join(', ') + '<br>' +
                            '基准值: ' + data.average.toFixed(2);
                        document.body.appendChild(alertDiv);
                        
                        setTimeout(function() {
                            alertDiv.style.opacity = '0';
                            setTimeout(function() { alertDiv.remove(); }, 500);
                        }, 5000);
                        break;
                        
                    case 'error_message':
                        toastr.error(data.message);
                        break;
                }
            };
            
        } catch (error) {
            console.error('WebSocket初始化失败:', error);
            toastr.error('WebSocket连接失败，请刷新页面重试');
        }
    }
    
    // 🔧 修复：自动扫描串口函数
    function autoRefreshPorts() {
        console.log('🔄 扫描串口...');
        $.get('/scan-ports/', function(data) {
            if (data.bridge_required) {
                // 显示桥接器提示
                $('#portsList').hide();
                $('#openPortBtn').prop('disabled', true);
                
                // 添加提示信息
                if (!$('#bridgeNotice').length) {
                    const notice = $(`
                        <div id="bridgeNotice" class="alert alert-info">
                            <h5><i class="fas fa-info-circle"></i> 云端部署说明</h5>
                            <p>当前运行在云端环境，无法直接访问本地串口设备。</p>
                            <p><strong>解决方案：</strong></p>
                            <ol>
                                <li>在您的本地电脑下载并运行桥接器程序</li>
                                <li>桥接器会自动将本地雷达数据发送到此云端界面</li>
                                <li>您可以在此界面查看实时数据和训练结果</li>
                            </ol>
                            <p><code>python local_bridge.py</code></p>
                        </div>
                    `);
                    $('#portsList').parent().append(notice);
                }
                
                toastr.info('云端环境需要本地桥接器支持');
            } else {
                // 原有逻辑...
            }
        });
    }

    function sendWebSocketCommand(command) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            toastr.error('WebSocket未连接，请刷新页面重试');
            return false;
        }
        try {
            ws.send(JSON.stringify(command));
            return true;
        } catch (e) {
            toastr.error('命令发送失败: ' + e.message);
            setTimeout(function() {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(command));
                }
            }, 1000);
            return false;
        }
    }

    // 初始化呼吸数据图表
    function initBreathChart() {
        const ctx = document.getElementById('breathChart').getContext('2d');
        breathChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: '呼吸数值',
                    data: chartData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: 'rgb(75, 192, 192)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: '实时呼吸数据监测'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '呼吸数值'
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: '时间'
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                },
                animation: {
                    duration: 200
                },
                interaction: {
                    intersect: false,
                    mode: 'index',
                }
            }
        });
    }

    function updateBreathChart(timestamp, value) {
        const timeStr = new Date(timestamp).toLocaleTimeString();
        
        chartLabels.push(timeStr);
        chartData.push(value);
        
        const maxPoints = 50;
        if (chartData.length > maxPoints) {
            chartData.shift();
            chartLabels.shift();
        }
        
        breathChart.data.labels = chartLabels;
        breathChart.data.datasets[0].data = chartData;
        breathChart.update('none');
    }

    function startTrainingCountdown() {
        let remainingTime = 60;
        const progressBar = document.getElementById('trainingProgress');
        const countdownSpan = document.getElementById('trainingCountdown');
        
        trainingCountdownTimer = setInterval(function() {
            remainingTime--;
            const progress = ((60 - remainingTime) / 60) * 100;
            
            progressBar.style.width = progress + '%';
            countdownSpan.textContent = '剩余时间: ' + remainingTime + '秒';
            
            if (remainingTime <= 0) {
                clearInterval(trainingCountdownTimer);
                countdownSpan.textContent = '训练即将结束...';
            }
        }, 1000);
    }

    function stopTrainingCountdown() {
        if (trainingCountdownTimer) {
            clearInterval(trainingCountdownTimer);
            trainingCountdownTimer = null;
        }
    }

    // 🔧 修复：页面初始化逻辑
    $(document).ready(function() {
        // 1. 首先初始化图表
        initBreathChart();
        
        // 2. 初始化WebSocket连接
        initWebSocket();
        
        // 3. 检测设备类型并应用不同策略
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        console.log('📱 设备类型: ' + (isMobile ? '移动端' : '桌面端'));
        
        // 刷新串口按钮点击事件
        $('#refreshPortsBtn').click(function() {
            autoRefreshPorts();
        });
        
        // 打开串口按钮
        $('#openPortBtn').click(function() {
            const selectedPort = $('#availablePorts').data('selectedPort');
            if (!selectedPort) {
                toastr.error('请先从列表中选择一个串口');
                return;
            }
            
            toastr.info('正在打开串口 ' + selectedPort + '...');
            $.post('/open-port/', JSON.stringify({port: selectedPort}), function(data) {
                if (data.success) {
                    toastr.success('串口 ' + selectedPort + ' 已打开');
                    $('#portStatus').text('已连接: ' + selectedPort);
                    portOpened = true;
                    // 🔧 修复：启用模式按钮
                    $('#trainingBtn').prop('disabled', false);
                    $('#monitoringBtn').prop('disabled', false);
                } else {
                    toastr.error('打开串口失败: ' + (data.error || '未知错误'));
                }
            }).fail(function() {
                toastr.error('串口连接请求失败');
            });
        });
        
        // 训练模式按钮
        $('#trainingBtn').click(function() {
            if (!portOpened) {
                toastr.error('请先打开串口');
                return;
            }
            
            const btn = $(this);
            if (btn.data('training')) {
                sendWebSocketCommand({ command: 'stop_training' });
                
                if (trainingTimer) {
                    clearTimeout(trainingTimer);
                    trainingTimer = null;
                }
                stopTrainingCountdown();
                
                btn.text('训练模式').data('training', false);
                $('#trainingStatus').hide();
                toastr.info('已手动停止训练');
                return;
            }
            
            sendWebSocketCommand({ command: 'start_training' });
            btn.prop('disabled', true).data('training', true).text('停止训练');
            $('#monitoringBtn').prop('disabled', true);
            
            chartData = [];
            chartLabels = [];
            breathChart.data.labels = chartLabels;
            breathChart.data.datasets[0].data = chartData;
            breathChart.update();
        });
        
        // 监测模式按钮
        $('#monitoringBtn').click(function() {
            if (!portOpened) {
                toastr.error('请先打开串口');
                return;
            }
            
            const btn = $(this);
            if (btn.data('monitoring')) {
                sendWebSocketCommand({ command: 'stop_monitoring' });
            } else {
                sendWebSocketCommand({ command: 'start_monitoring' });
                
                chartData = [];
                chartLabels = [];
                breathChart.data.labels = chartLabels;
                breathChart.data.datasets[0].data = chartData;
                breathChart.update();
            }
        });
    });
</script>
{% endblock %}
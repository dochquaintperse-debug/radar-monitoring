{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3>é›·è¾¾æ•°æ®ç›‘æ§</h3>
            </div>
            <div class="card-body">
                <!-- ä¸²å£æ‰«æçŠ¶æ€ -->
                <div class="alert alert-info" role="alert">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-search"></i> ä¸²å£çŠ¶æ€:
                            <span id="portStatus">æœªè¿æ¥</span>
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <div class="d-flex gap-2 flex-wrap">
                        <button id="refreshPortsBtn" class="btn btn-outline-secondary">
                            åˆ·æ–°ä¸²å£
                        </button>
                        <button id="openPortBtn" class="btn btn-outline-primary" disabled>
                            æ‰“å¼€ä¸²å£
                        </button>
                    </div>
                </div>
                
                <!-- ä¸²å£åˆ—è¡¨ -->
                <div class="mb-3" id="portsList" style="display: none;">
                    <label class="form-label">å¯ç”¨ä¸²å£:</label>
                    <div class="list-group" id="availablePorts">
                        <!-- ä¸²å£åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </div>
                </div>
                
                <!-- æ¨¡å¼æŒ‰é’® -->
                <div class="button-container">
                    <button id="trainingBtn" class="btn btn-primary btn-lg mr-3" disabled>è®­ç»ƒæ¨¡å¼</button>
                    <button id="monitoringBtn" class="btn btn-success btn-lg" disabled>ç›‘æµ‹æ¨¡å¼</button>
                </div>
                
                <!-- è®­ç»ƒçŠ¶æ€æ˜¾ç¤º -->
                <div id="trainingStatus" style="display: none; margin-bottom: 20px;">
                    <div class="alert alert-warning" role="alert">
                        <strong>è®­ç»ƒè¿›è¡Œä¸­...</strong>
                        <div class="progress mt-2">
                            <div id="trainingProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <span id="trainingCountdown">å‰©ä½™æ—¶é—´: 60ç§’</span>
                    </div>
                </div>
                
                <h4>å‘¼å¸æ•°æ®å®æ—¶å›¾è¡¨</h4>
                <div style="height: 300px; margin-bottom: 20px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px;">
                    <canvas id="breathChart"></canvas>
                </div>
                
                <h4>å®æ—¶æ•°æ®</h4>
                <div class="data-container">
                    <ul id="realtime-data" class="list-group">
                        <li class="list-group-item text-muted">ç­‰å¾…æ•°æ®...</li>
                    </ul>
                </div>
                
                <div class="mt-3">
                    <h4>ä¼ æ„Ÿå™¨çŠ¶æ€</h4>
                    <div id="sensorStatus">
                        {% if sensors %}
                            {% for sensor in sensors %}
                            <div class="card mb-2">
                                <div class="card-body">
                                    <h5 class="card-title">{{ sensor.display_name }}</h5>
                                    {% if sensor.latest_training %}
                                        <p class="card-text">å¹³å‡å€¼: {{ sensor.latest_training.average_value|floatformat:2 }}</p>
                                        <p class="card-text text-muted">{{ sensor.latest_training.created_at }}</p>
                                        <p class="card-text">
                                            æœ€æ–°æ•°å€¼: 
                                            <span id="latest-value-{{ sensor.id }}" class="badge badge-info">--</span>
                                        </p>
                                    {% else %}
                                        <p class="card-text text-warning">æœªè®­ç»ƒ</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p>æ²¡æœ‰å¯ç”¨çš„ä¼ æ„Ÿå™¨</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h3>è®­ç»ƒç»“æœ</h3>
            </div>
            <div class="card-body">
                <div id="trainingResults">
                    {% if sensors %}
                        {% for sensor in sensors %}
                            {% if sensor.latest_training %}
                                <div class="card mb-2">
                                    <div class="card-body">
                                        <h5 class="card-title">{{ sensor.display_name }}</h5>
                                        <p class="card-text">å¹³å‡å€¼: {{ sensor.latest_training.average_value|floatformat:2 }}</p>
                                        <p class="card-text text-muted">{{ sensor.latest_training.created_at }}</p>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% else %}
                        <p>æ²¡æœ‰è®­ç»ƒç»“æœ</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let breathChart;
    let chartData = [];
    let chartLabels = [];
    let trainingTimer = null;
    let trainingCountdownTimer = null;
    let portOpened = false;
    let ws = null;
    
    // ğŸ”§ å…³é”®ä¿®å¤ï¼šæ™ºèƒ½WebSocketè¿æ¥
    function initWebSocket() {
        // è‡ªåŠ¨æ£€æµ‹åè®®ï¼ˆHTTP/HTTPSå¯¹åº”ws/wssï¼‰
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = protocol + '//' + window.location.host + '/ws/radar/';
        
        console.log('ğŸ”— å°è¯•è¿æ¥WebSocket: ' + wsUrl);
        
        try {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                document.getElementById('statusIndicator').className = 'connected';
                document.getElementById('connectionStatus').textContent = 'è¿æ¥çŠ¶æ€ï¼šå·²è¿æ¥';
                toastr.success('WebSocketè¿æ¥æˆåŠŸ');
                
                // ğŸ”§ ä¿®å¤ï¼šè¿æ¥æˆåŠŸåç«‹å³è‡ªåŠ¨æ‰«æä¸²å£
                setTimeout(function() {
                    autoRefreshPorts();
                }, 1000);
            };

            ws.onclose = function(event) {
                document.getElementById('statusIndicator').className = 'disconnected';
                document.getElementById('connectionStatus').textContent = 'è¿æ¥çŠ¶æ€ï¼šå·²æ–­å¼€';
                
                if (event.wasClean) {
                    toastr.warning('WebSocketè¿æ¥å·²å…³é—­');
                } else {
                    toastr.error('WebSocketè¿æ¥æ„å¤–æ–­å¼€ï¼Œ3ç§’åé‡è¯•...');
                    setTimeout(initWebSocket, 3000);
                }
            };

            ws.onerror = function(error) {
                console.error('WebSocketé”™è¯¯:', error);
                toastr.error('WebSocketè¿æ¥å¤±è´¥');
            };
            
            // ç°æœ‰çš„æ¶ˆæ¯å¤„ç†é€»è¾‘ä¿æŒä¸å˜
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                switch(data.type) {
                    case 'training_started':
                        toastr.info(data.message);
                        $('#trainingStatus').show();
                        startTrainingCountdown();
                        
                        trainingTimer = setTimeout(function() {
                            sendWebSocketCommand({ command: 'stop_training' });
                            toastr.warning('è®­ç»ƒæ—¶é—´å·²åˆ°ï¼Œè‡ªåŠ¨ç»“æŸè®­ç»ƒ');
                        }, 60000);
                        break;

                    case 'radar_data':
                        const dataList = document.getElementById('realtime-data');
                        
                        if (dataList.children.length === 1 && dataList.children[0].textContent === 'ç­‰å¾…æ•°æ®...') {
                            dataList.innerHTML = '';
                        }
                        
                        const newItem = document.createElement('li');
                        newItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        
                        const timeStr = new Date(data.timestamp).toLocaleTimeString();
                        // ğŸ”§ å…³é”®ä¿®å¤ï¼šé¿å…æ¨¡æ¿è¯­æ³•å†²çªï¼Œä½¿ç”¨å­—ç¬¦ä¸²æ‹¼æ¥
                        newItem.innerHTML = '<div>' +
                            '<strong>ä¼ æ„Ÿå™¨' + data.sensor_id + '</strong>: ' + data.value + ' ' +
                            '<small class="text-muted">(' + data.hex_value + ')</small>' +
                            '</div>' +
                            '<small class="text-muted">' + timeStr + '</small>';
                        
                        dataList.insertBefore(newItem, dataList.firstChild);

                        const sensorIdNum = data.sensor_id.replace(/\D/g, '');
                        const latestValueElem = document.getElementById('latest-value-' + sensorIdNum);
                        if (latestValueElem) {
                            latestValueElem.textContent = data.value;
                            latestValueElem.className = 'badge badge-success';
                            
                            setTimeout(function() {
                                latestValueElem.className = 'badge badge-info';
                            }, 3000);
                        }

                        while (dataList.children.length > 20) {
                            dataList.removeChild(dataList.lastChild);
                        }
                        
                        updateBreathChart(data.timestamp, data.value);
                        break;
                        
                    case 'training_complete':
                        toastr.success('ä¼ æ„Ÿå™¨ ' + data.sensor_id + ' è®­ç»ƒå®Œæˆï¼Œå¹³å‡å€¼: ' + data.average_value.toFixed(2));
                        
                        if (trainingTimer) {
                            clearTimeout(trainingTimer);
                            trainingTimer = null;
                        }
                        stopTrainingCountdown();
                        
                        $('#trainingBtn').prop('disabled', false).text('è®­ç»ƒæ¨¡å¼').data('training', false);
                        $('#monitoringBtn').prop('disabled', false);
                        $('#trainingStatus').hide();
                        
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                        break;

                    case 'monitoring_started':
                        $('#monitoringBtn').text('åœæ­¢ç›‘æµ‹').removeClass('btn-success').addClass('btn-danger');
                        $('#monitoringBtn').data('monitoring', true);
                        toastr.info('ç›‘æµ‹å·²å¼€å§‹');
                        break;

                    case 'monitoring_stopped':
                        $('#monitoringBtn').text('ç›‘æµ‹æ¨¡å¼').removeClass('btn-danger').addClass('btn-success');
                        $('#monitoringBtn').data('monitoring', false);
                        toastr.info('å·²åœæ­¢ç›‘æµ‹');
                        break;

                    case 'anomaly_detected':
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'anomaly-alert';
                        alertDiv.innerHTML = '<strong>å¼‚å¸¸è­¦å‘Š!</strong><br>' +
                            'ä¼ æ„Ÿå™¨ ' + data.sensor_id + ' æ£€æµ‹åˆ°è¿ç»­å¼‚å¸¸<br>' +
                            'å¼‚å¸¸å€¼: ' + data.values.join(', ') + '<br>' +
                            'åŸºå‡†å€¼: ' + data.average.toFixed(2);
                        document.body.appendChild(alertDiv);
                        
                        setTimeout(function() {
                            alertDiv.style.opacity = '0';
                            setTimeout(function() { alertDiv.remove(); }, 500);
                        }, 5000);
                        break;
                        
                    case 'error_message':
                        toastr.error(data.message);
                        break;
                }
            };
            
        } catch (error) {
            console.error('WebSocketåˆå§‹åŒ–å¤±è´¥:', error);
            toastr.error('WebSocketè¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        }
    }
    
    // ğŸ”§ ä¿®å¤ï¼šè‡ªåŠ¨æ‰«æä¸²å£å‡½æ•°
    function autoRefreshPorts() {
        console.log('ğŸ”„ æ‰«æä¸²å£...');
        $.get('/scan-ports/', function(data) {
            if (data.bridge_required) {
                // æ˜¾ç¤ºæ¡¥æ¥å™¨æç¤º
                $('#portsList').hide();
                $('#openPortBtn').prop('disabled', true);
                
                // æ·»åŠ æç¤ºä¿¡æ¯
                if (!$('#bridgeNotice').length) {
                    const notice = $(`
                        <div id="bridgeNotice" class="alert alert-info">
                            <h5><i class="fas fa-info-circle"></i> äº‘ç«¯éƒ¨ç½²è¯´æ˜</h5>
                            <p>å½“å‰è¿è¡Œåœ¨äº‘ç«¯ç¯å¢ƒï¼Œæ— æ³•ç›´æ¥è®¿é—®æœ¬åœ°ä¸²å£è®¾å¤‡ã€‚</p>
                            <p><strong>è§£å†³æ–¹æ¡ˆï¼š</strong></p>
                            <ol>
                                <li>åœ¨æ‚¨çš„æœ¬åœ°ç”µè„‘ä¸‹è½½å¹¶è¿è¡Œæ¡¥æ¥å™¨ç¨‹åº</li>
                                <li>æ¡¥æ¥å™¨ä¼šè‡ªåŠ¨å°†æœ¬åœ°é›·è¾¾æ•°æ®å‘é€åˆ°æ­¤äº‘ç«¯ç•Œé¢</li>
                                <li>æ‚¨å¯ä»¥åœ¨æ­¤ç•Œé¢æŸ¥çœ‹å®æ—¶æ•°æ®å’Œè®­ç»ƒç»“æœ</li>
                            </ol>
                            <p><code>python local_bridge.py</code></p>
                        </div>
                    `);
                    $('#portsList').parent().append(notice);
                }
                
                toastr.info('äº‘ç«¯ç¯å¢ƒéœ€è¦æœ¬åœ°æ¡¥æ¥å™¨æ”¯æŒ');
            } else {
                // åŸæœ‰é€»è¾‘...
            }
        });
    }

    function sendWebSocketCommand(command) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            toastr.error('WebSocketæœªè¿æ¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return false;
        }
        try {
            ws.send(JSON.stringify(command));
            return true;
        } catch (e) {
            toastr.error('å‘½ä»¤å‘é€å¤±è´¥: ' + e.message);
            setTimeout(function() {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify(command));
                }
            }, 1000);
            return false;
        }
    }

    // åˆå§‹åŒ–å‘¼å¸æ•°æ®å›¾è¡¨
    function initBreathChart() {
        const ctx = document.getElementById('breathChart').getContext('2d');
        breathChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: chartLabels,
                datasets: [{
                    label: 'å‘¼å¸æ•°å€¼',
                    data: chartData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 4,
                    pointBackgroundColor: 'rgb(75, 192, 192)',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'å®æ—¶å‘¼å¸æ•°æ®ç›‘æµ‹'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'å‘¼å¸æ•°å€¼'
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'æ—¶é—´'
                        },
                        grid: {
                            color: 'rgba(0,0,0,0.1)'
                        }
                    }
                },
                animation: {
                    duration: 200
                },
                interaction: {
                    intersect: false,
                    mode: 'index',
                }
            }
        });
    }

    function updateBreathChart(timestamp, value) {
        const timeStr = new Date(timestamp).toLocaleTimeString();
        
        chartLabels.push(timeStr);
        chartData.push(value);
        
        const maxPoints = 50;
        if (chartData.length > maxPoints) {
            chartData.shift();
            chartLabels.shift();
        }
        
        breathChart.data.labels = chartLabels;
        breathChart.data.datasets[0].data = chartData;
        breathChart.update('none');
    }

    function startTrainingCountdown() {
        let remainingTime = 60;
        const progressBar = document.getElementById('trainingProgress');
        const countdownSpan = document.getElementById('trainingCountdown');
        
        trainingCountdownTimer = setInterval(function() {
            remainingTime--;
            const progress = ((60 - remainingTime) / 60) * 100;
            
            progressBar.style.width = progress + '%';
            countdownSpan.textContent = 'å‰©ä½™æ—¶é—´: ' + remainingTime + 'ç§’';
            
            if (remainingTime <= 0) {
                clearInterval(trainingCountdownTimer);
                countdownSpan.textContent = 'è®­ç»ƒå³å°†ç»“æŸ...';
            }
        }, 1000);
    }

    function stopTrainingCountdown() {
        if (trainingCountdownTimer) {
            clearInterval(trainingCountdownTimer);
            trainingCountdownTimer = null;
        }
    }

    // ğŸ”§ ä¿®å¤ï¼šé¡µé¢åˆå§‹åŒ–é€»è¾‘
    $(document).ready(function() {
        // 1. é¦–å…ˆåˆå§‹åŒ–å›¾è¡¨
        initBreathChart();
        
        // 2. åˆå§‹åŒ–WebSocketè¿æ¥
        initWebSocket();
        
        // 3. æ£€æµ‹è®¾å¤‡ç±»å‹å¹¶åº”ç”¨ä¸åŒç­–ç•¥
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        console.log('ğŸ“± è®¾å¤‡ç±»å‹: ' + (isMobile ? 'ç§»åŠ¨ç«¯' : 'æ¡Œé¢ç«¯'));
        
        // åˆ·æ–°ä¸²å£æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        $('#refreshPortsBtn').click(function() {
            autoRefreshPorts();
        });
        
        // æ‰“å¼€ä¸²å£æŒ‰é’®
        $('#openPortBtn').click(function() {
            const selectedPort = $('#availablePorts').data('selectedPort');
            if (!selectedPort) {
                toastr.error('è¯·å…ˆä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªä¸²å£');
                return;
            }
            
            toastr.info('æ­£åœ¨æ‰“å¼€ä¸²å£ ' + selectedPort + '...');
            $.post('/open-port/', JSON.stringify({port: selectedPort}), function(data) {
                if (data.success) {
                    toastr.success('ä¸²å£ ' + selectedPort + ' å·²æ‰“å¼€');
                    $('#portStatus').text('å·²è¿æ¥: ' + selectedPort);
                    portOpened = true;
                    // ğŸ”§ ä¿®å¤ï¼šå¯ç”¨æ¨¡å¼æŒ‰é’®
                    $('#trainingBtn').prop('disabled', false);
                    $('#monitoringBtn').prop('disabled', false);
                } else {
                    toastr.error('æ‰“å¼€ä¸²å£å¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                }
            }).fail(function() {
                toastr.error('ä¸²å£è¿æ¥è¯·æ±‚å¤±è´¥');
            });
        });
        
        // è®­ç»ƒæ¨¡å¼æŒ‰é’®
        $('#trainingBtn').click(function() {
            if (!portOpened) {
                toastr.error('è¯·å…ˆæ‰“å¼€ä¸²å£');
                return;
            }
            
            const btn = $(this);
            if (btn.data('training')) {
                sendWebSocketCommand({ command: 'stop_training' });
                
                if (trainingTimer) {
                    clearTimeout(trainingTimer);
                    trainingTimer = null;
                }
                stopTrainingCountdown();
                
                btn.text('è®­ç»ƒæ¨¡å¼').data('training', false);
                $('#trainingStatus').hide();
                toastr.info('å·²æ‰‹åŠ¨åœæ­¢è®­ç»ƒ');
                return;
            }
            
            sendWebSocketCommand({ command: 'start_training' });
            btn.prop('disabled', true).data('training', true).text('åœæ­¢è®­ç»ƒ');
            $('#monitoringBtn').prop('disabled', true);
            
            chartData = [];
            chartLabels = [];
            breathChart.data.labels = chartLabels;
            breathChart.data.datasets[0].data = chartData;
            breathChart.update();
        });
        
        // ç›‘æµ‹æ¨¡å¼æŒ‰é’®
        $('#monitoringBtn').click(function() {
            if (!portOpened) {
                toastr.error('è¯·å…ˆæ‰“å¼€ä¸²å£');
                return;
            }
            
            const btn = $(this);
            if (btn.data('monitoring')) {
                sendWebSocketCommand({ command: 'stop_monitoring' });
            } else {
                sendWebSocketCommand({ command: 'start_monitoring' });
                
                chartData = [];
                chartLabels = [];
                breathChart.data.labels = chartLabels;
                breathChart.data.datasets[0].data = chartData;
                breathChart.update();
            }
        });
    });
</script>
{% endblock %}